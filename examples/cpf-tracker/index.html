<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPF Project Tracker - Financial Management Suite</title>
    
    <!-- Core Modules -->
    <script src="../../core/ledger.js"></script>
    <script src="../../core/rbac.js"></script>
    <script src="../../core/approval-engine.js"></script>
    <script src="../../core/funding-tracker.js"></script>
    <script src="../../core/qa-gates.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --purple: #7c3aed;
            --bg: #f8fafc;
            --text: #1e293b;
            --border: #e2e8f0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary), #1e40af);
            color: white;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .header h1 { font-size: 1.5rem; margin-bottom: 0.25rem; }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        
        /* Portfolio Dashboard */
        .portfolio-dashboard {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .financial-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .financial-card {
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .financial-card.recommended { background: #f3e8ff; border-color: var(--purple); }
        .financial-card.selected { background: #dbeafe; border-color: var(--primary); }
        .financial-card.estimated { background: #fef3c7; border-color: var(--warning); }
        .financial-card.incentivized { background: #d1fae5; border-color: var(--success); }
        .financial-card.net { background: #fee2e2; border-color: var(--danger); }
        
        .financial-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 600;
            color: #666;
            margin-bottom: 0.25rem;
        }
        
        .financial-amount {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .financial-count {
            font-size: 0.875rem;
            color: #666;
        }
        
        /* Workflow Navigator */
        .workflow-nav {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .workflow-stages {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding: 0.5rem 0;
        }
        
        .stage-chip {
            padding: 0.75rem 1.25rem;
            border-radius: 24px;
            border: 2px solid var(--border);
            background: white;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        .stage-chip:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .stage-chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .stage-count {
            background: rgba(0,0,0,0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .stage-chip.active .stage-count {
            background: rgba(255,255,255,0.3);
        }
        
        /* Quick Actions */
        .quick-actions {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-secondary { background: var(--border); color: var(--text); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .select-all-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-right: 1px solid var(--border);
            margin-right: 0.5rem;
        }
        
        .checkbox-custom {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* Project Grid */
        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
            gap: 1.25rem;
        }
        
        .project-card {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary);
            transition: all 0.2s;
            position: relative;
        }
        
        .project-card.selected {
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            border-left-width: 6px;
        }
        
        .project-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .card-checkbox {
            position: absolute;
            top: 1rem;
            left: 1rem;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .card-content {
            margin-left: 2rem;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-intake { background: #dbeafe; color: #1e40af; }
        .status-hea { background: #fef3c7; color: #92400e; }
        .status-scoping { background: #fce7f3; color: #9f1239; }
        .status-bidding { background: #e0e7ff; color: #3730a3; }
        .status-approved { background: #d1fae5; color: #065f46; }
        .status-implementation { background: #dbeafe; color: #1e40af; }
        .status-completed { background: #d1fae5; color: #065f46; }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        /* Financial Display on Cards */
        .card-financials {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin: 1rem 0;
            padding: 1rem;
            background: var(--bg);
            border-radius: 8px;
        }
        
        .mini-financial {
            text-align: center;
        }
        
        .mini-financial-label {
            font-size: 0.625rem;
            text-transform: uppercase;
            color: #666;
            font-weight: 600;
        }
        
        .mini-financial-amount {
            font-size: 1rem;
            font-weight: 700;
            margin-top: 0.25rem;
        }
        
        .mini-financial.recommended .mini-financial-amount { color: var(--purple); }
        .mini-financial.selected .mini-financial-amount { color: var(--primary); }
        .mini-financial.estimated .mini-financial-amount { color: var(--warning); }
        .mini-financial.incentivized .mini-financial-amount { color: var(--success); }
        .mini-financial.net .mini-financial-amount { color: var(--danger); }
        
        /* Quick Action Buttons */
        .card-quick-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .quick-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border);
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .quick-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .quick-btn.primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .form-group {
            margin-bottom: 1.25rem;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.875rem;
        }
        
        .form-group input[type="number"] {
            text-align: right;
        }
        
        /* Measure/Bid List */
        .measure-list, .bid-list {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            background: var(--bg);
        }
        
        .measure-item, .bid-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 1rem;
            align-items: center;
            padding: 0.75rem;
            background: white;
            border-radius: 6px;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
        }
        
        .measure-item:last-child, .bid-item:last-child {
            margin-bottom: 0;
        }
        
        .measure-name {
            font-weight: 600;
        }
        
        .measure-cost, .bid-cost {
            text-align: right;
            font-weight: 700;
            color: var(--primary);
        }
        
        .measure-incentive {
            text-align: right;
            font-weight: 700;
            color: var(--success);
        }
        
        .remove-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
        }
        
        .add-measure-btn, .add-bid-btn {
            width: 100%;
            padding: 0.75rem;
            background: var(--border);
            border: 2px dashed #999;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            margin-top: 0.75rem;
        }
        
        .add-measure-btn:hover, .add-bid-btn:hover {
            background: #ddd;
            border-color: var(--primary);
            color: var(--primary);
        }
        
        /* Cost Summary in Modal */
        .cost-summary {
            background: var(--bg);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
        }
        
        .cost-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.875rem;
        }
        
        .cost-row.total {
            border-top: 2px solid var(--border);
            margin-top: 0.5rem;
            padding-top: 1rem;
            font-size: 1.125rem;
            font-weight: 700;
        }
        
        .cost-amount {
            font-weight: 700;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 22px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 22px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--success);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }
        
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .three-col {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>üíº CPF Project Tracker - Financial Management Suite</h1>
            <p style="opacity: 0.9; font-size: 0.875rem;">Comprehensive cost tracking with stage-specific workflows</p>
        </div>
    </div>
    
    <div class="container">
        <!-- Portfolio Financial Dashboard -->
        <div class="portfolio-dashboard">
            <h3 style="margin-bottom: 0.5rem;">üìä Portfolio Financial Summary</h3>
            <p style="font-size: 0.875rem; color: #666; margin-bottom: 1rem;">
                <span id="portfolioScope">All Projects</span> ‚Ä¢ 
                <span id="portfolioCount">0</span> projects
            </p>
            <div class="financial-summary">
                <div class="financial-card recommended">
                    <div class="financial-label">Recommended Total</div>
                    <div class="financial-amount" id="portfolio-recommended">$0</div>
                    <div class="financial-count"><span id="portfolio-recommended-count">0</span> measures</div>
                </div>
                <div class="financial-card selected">
                    <div class="financial-label">Selected Total</div>
                    <div class="financial-amount" id="portfolio-selected">$0</div>
                    <div class="financial-count"><span id="portfolio-selected-count">0</span> measures</div>
                </div>
                <div class="financial-card estimated">
                    <div class="financial-label">Estimated Cost</div>
                    <div class="financial-amount" id="portfolio-estimated">$0</div>
                    <div class="financial-count">Contractor estimates</div>
                </div>
                <div class="financial-card incentivized">
                    <div class="financial-label">Total Incentives</div>
                    <div class="financial-amount" id="portfolio-incentivized">$0</div>
                    <div class="financial-count">Rebates & credits</div>
                </div>
                <div class="financial-card net">
                    <div class="financial-label">Net Cost</div>
                    <div class="financial-amount" id="portfolio-net">$0</div>
                    <div class="financial-count">After incentives</div>
                </div>
            </div>
        </div>
        
        <!-- Workflow Navigator -->
        <div class="workflow-nav">
            <div class="workflow-stages" id="workflowStages"></div>
        </div>
        
        <!-- Quick Actions -->
        <div class="quick-actions">
            <div class="select-all-container">
                <input type="checkbox" id="selectAll" class="checkbox-custom" onchange="toggleSelectAll()">
                <label for="selectAll" style="cursor: pointer; font-size: 0.875rem;">Select All</label>
            </div>
            
            <button class="btn btn-primary" onclick="openNewProjectModal()">
                ‚ûï New Project
            </button>
            
            <button class="btn btn-success" id="bulkApproveBtn" onclick="bulkApprove()" disabled>
                ‚úÖ Bulk Approve
            </button>
            
            <button class="btn btn-secondary" id="bulkExportBtn" onclick="bulkExport()" disabled>
                üì• Export Selected
            </button>
            
            <button class="btn btn-secondary" onclick="exportPortfolio()">
                üìä Export Portfolio
            </button>
            
            <div style="margin-left: auto; font-size: 0.875rem; color: #666;">
                <span id="selectedCount">0</span> selected
            </div>
        </div>
        
        <!-- Project Grid -->
        <div class="project-grid" id="projectGrid"></div>
    </div>
    
    <!-- New Project Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Project</h2>
                <button class="modal-close" onclick="closeModal('projectModal')">√ó</button>
            </div>
            <form id="projectForm">
                <div class="two-col">
                    <div class="form-group">
                        <label>Project Type *</label>
                        <select id="projectType" required>
                            <option value="">Select type...</option>
                            <option value="weatherization">Weatherization</option>
                            <option value="heat-pump">Heat Pump Installation</option>
                            <option value="solar">Solar Installation</option>
                            <option value="insulation">Insulation Upgrade</option>
                            <option value="hvac">HVAC Replacement</option>
                            <option value="windows">Window Replacement</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Customer Scenario *</label>
                        <select id="customerScenario" required>
                            <option value="">Select scenario...</option>
                            <option value="low-income-homeowner">Low-Income Homeowner</option>
                            <option value="moderate-income-homeowner">Moderate-Income Homeowner</option>
                            <option value="renter-with-permission">Renter (with permission)</option>
                            <option value="landlord-owner">Landlord/Property Owner</option>
                            <option value="manufactured-home">Manufactured Home Owner</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Address *</label>
                    <input type="text" id="address" placeholder="123 Main St, Portland OR" required>
                </div>
                
                <div class="form-group">
                    <label>Income Qualification Status</label>
                    <select id="qualified">
                        <option value="pending">‚è≥ Pending Verification</option>
                        <option value="yes">‚úÖ Qualified</option>
                        <option value="no">‚ùå Not Qualified - Refer</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('projectModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Project</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Scoping/Measures Modal -->
    <div class="modal" id="scopingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìê Scoping & Measures</h2>
                <button class="modal-close" onclick="closeModal('scopingModal')">√ó</button>
            </div>
            
            <p style="margin-bottom: 1rem; color: #666;">Add recommended and selected measures with estimated costs and incentives.</p>
            
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                <select id="measureLibrary" style="flex: 1; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px;">
                    <option value="">Select from measure library...</option>
                </select>
                <button class="btn btn-primary" onclick="addMeasureFromLibrary()" style="white-space: nowrap;">+ Add Selected</button>
                <button class="btn btn-secondary" onclick="importMeasures()" title="Import JSON">üì• Import</button>
                <button class="btn btn-secondary" onclick="exportMeasureLibrary()" title="Export Library">üì§ Export</button>
            </div>
            
            <div class="measure-list" id="measureList"></div>
            
            <div class="cost-summary">
                <div class="cost-row">
                    <span>Recommended Total:</span>
                    <span class="cost-amount" id="modal-recommended">$0</span>
                </div>
                <div class="cost-row">
                    <span>Selected Total:</span>
                    <span class="cost-amount" id="modal-selected">$0</span>
                </div>
                <div class="cost-row">
                    <span>Total Incentives:</span>
                    <span class="cost-amount" style="color: var(--success);" id="modal-incentives">$0</span>
                </div>
                <div class="cost-row total">
                    <span>Net Cost (Selected - Incentives):</span>
                    <span class="cost-amount" style="color: var(--danger);" id="modal-net">$0</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('scopingModal')">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveMeasures()">üíæ Save Measures</button>
            </div>
        </div>
    </div>
    
    <!-- Bidding Modal -->
    <div class="modal" id="biddingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí∞ Contractor Bids</h2>
                <button class="modal-close" onclick="closeModal('biddingModal')">√ó</button>
            </div>
            
            <p style="margin-bottom: 1rem; color: #666;">Collect and compare contractor bids for selected measures.</p>
            
            <div class="bid-list" id="bidList"></div>
            
            <button class="add-bid-btn" onclick="addBid()">+ Add Contractor Bid</button>
            
            <div class="cost-summary">
                <div class="cost-row">
                    <span>Selected Bid:</span>
                    <span class="cost-amount" id="modal-bid-selected">$0</span>
                </div>
                <div class="cost-row">
                    <span>Total Incentives:</span>
                    <span class="cost-amount" style="color: var(--success);" id="modal-bid-incentives">$0</span>
                </div>
                <div class="cost-row total">
                    <span>Net Cost:</span>
                    <span class="cost-amount" style="color: var(--danger);" id="modal-bid-net">$0</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('biddingModal')">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveBids()">üíæ Save Bids</button>
            </div>
        </div>
    </div>
    
    <!-- Implementation/Actual Costs Modal -->
    <div class="modal" id="implementationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üî® Implementation & Actual Costs</h2>
                <button class="modal-close" onclick="closeModal('implementationModal')">√ó</button>
            </div>
            
            <div class="form-group">
                <label>Actual Project Cost</label>
                <input type="number" id="actualCost" placeholder="0.00" step="0.01">
            </div>
            
            <div class="form-group">
                <label>Incentives Applied</label>
                <input type="number" id="actualIncentives" placeholder="0.00" step="0.01">
            </div>
            
            <div class="cost-summary">
                <div class="cost-row">
                    <span>Actual Cost:</span>
                    <span class="cost-amount" id="modal-actual">$0</span>
                </div>
                <div class="cost-row">
                    <span>Incentives Applied:</span>
                    <span class="cost-amount" style="color: var(--success);" id="modal-actual-incentives">$0</span>
                </div>
                <div class="cost-row total">
                    <span>Net Cost to Customer:</span>
                    <span class="cost-amount" style="color: var(--danger);" id="modal-actual-net">$0</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('implementationModal')">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveActualCosts()">üíæ Save Actual Costs</button>
            </div>
        </div>
    </div>
    
    <script>
        // Measure Library - Pre-defined measures with typical costs and incentives
        const measureLibrary = [
            { name: 'Attic Insulation (R-38)', category: 'Insulation', typicalCost: 2500, typicalIncentive: 500 },
            { name: 'Wall Insulation', category: 'Insulation', typicalCost: 3500, typicalIncentive: 700 },
            { name: 'Floor Insulation', category: 'Insulation', typicalCost: 2000, typicalIncentive: 400 },
            { name: 'Air Sealing & Weatherization', category: 'Weatherization', typicalCost: 1500, typicalIncentive: 300 },
            { name: 'Duct Sealing & Insulation', category: 'Weatherization', typicalCost: 1200, typicalIncentive: 250 },
            { name: 'Heat Pump (Mini-Split)', category: 'HVAC', typicalCost: 8000, typicalIncentive: 2000 },
            { name: 'Heat Pump (Ducted)', category: 'HVAC', typicalCost: 12000, typicalIncentive: 3000 },
            { name: 'Heat Pump Water Heater', category: 'Water Heating', typicalCost: 3500, typicalIncentive: 1000 },
            { name: 'Solar Water Heater', category: 'Water Heating', typicalCost: 5500, typicalIncentive: 1500 },
            { name: 'Windows - Double Pane (per window)', category: 'Windows', typicalCost: 650, typicalIncentive: 100 },
            { name: 'Windows - Triple Pane (per window)', category: 'Windows', typicalCost: 900, typicalIncentive: 150 },
            { name: 'Solar PV System (5kW)', category: 'Solar', typicalCost: 15000, typicalIncentive: 4500 },
            { name: 'Solar PV System (10kW)', category: 'Solar', typicalCost: 25000, typicalIncentive: 7500 },
            { name: 'Electric Panel Upgrade (200A)', category: 'Electrical', typicalCost: 2500, typicalIncentive: 500 },
            { name: 'LED Lighting Upgrade (whole home)', category: 'Lighting', typicalCost: 800, typicalIncentive: 200 },
            { name: 'Smart Thermostat', category: 'Controls', typicalCost: 250, typicalIncentive: 75 },
            { name: 'Refrigerator (ENERGY STAR)', category: 'Appliances', typicalCost: 1200, typicalIncentive: 200 },
            { name: 'Clothes Washer (ENERGY STAR)', category: 'Appliances', typicalCost: 800, typicalIncentive: 150 },
            { name: 'Clothes Dryer - Heat Pump', category: 'Appliances', typicalCost: 1400, typicalIncentive: 300 }
        ];
        
        // Initialize core modules
        const ledger = new Ledger({ storageKey: 'cpf_ledger_financial' });
        const rbac = new RBAC();
        const approvals = new ApprovalEngine();
        const funding = new FundingTracker();
        const qaGates = new QAGates();
        
        const currentUser = { id: 'pm_john', name: 'John PM', role: 'pm' };
        
        let projects = JSON.parse(localStorage.getItem('cpf_projects_financial') || '[]');
        let selectedProjects = new Set();
        let currentStageFilter = 'all';
        let currentEditingProject = null;
        
        const stages = [
            { id: 'all', label: 'All', icon: 'üìã' },
            { id: 'intake', label: 'Intake', icon: 'üìù' },
            { id: 'hea', label: 'HEA', icon: 'üè†' },
            { id: 'scoping', label: 'Scoping', icon: 'üìê' },
            { id: 'bidding', label: 'Bidding', icon: 'üí∞' },
            { id: 'approved', label: 'Approved', icon: '‚úÖ' },
            { id: 'implementation', label: 'Implementation', icon: 'üî®' },
            { id: 'completed', label: 'Completed', icon: 'üéâ' }
        ];
        
        // Initialize
        function init() {
            if (projects.length === 0) {
                createSampleProjects();
            }
            renderWorkflowNav();
            renderProjects();
            updatePortfolioDashboard();
        }
        
        function createSampleProjects() {
            const samples = [
                {
                    id: 'CPF-001',
                    type: 'weatherization',
                    scenario: 'low-income-homeowner',
                    address: '123 Main St, Portland OR',
                    status: 'scoping',
                    qualified: 'yes',
                    form300: true,
                    form320: false,
                    measures: [],
                    bids: [],
                    financials: {
                        recommended: 0,
                        selected: 0,
                        estimated: 0,
                        incentivized: 0,
                        net: 0,
                        actual: 0
                    },
                    createdDate: new Date().toISOString()
                },
                {
                    id: 'CPF-002',
                    type: 'heat-pump',
                    scenario: 'moderate-income-homeowner',
                    address: '456 Oak Ave, Portland OR',
                    status: 'bidding',
                    qualified: 'yes',
                    form300: true,
                    form320: false,
                    measures: [
                        { name: 'Heat Pump Installation', cost: 8000, incentive: 2000, selected: true }
                    ],
                    bids: [],
                    financials: {
                        recommended: 8000,
                        selected: 8000,
                        estimated: 0,
                        incentivized: 2000,
                        net: 6000,
                        actual: 0
                    },
                    createdDate: new Date().toISOString()
                }
            ];
            projects = samples;
            saveProjects();
        }
        
        function renderWorkflowNav() {
            const container = document.getElementById('workflowStages');
            container.innerHTML = stages.map(stage => {
                const count = stage.id === 'all' ? projects.length : projects.filter(p => p.status === stage.id).length;
                return `
                    <div class="stage-chip ${currentStageFilter === stage.id ? 'active' : ''}" 
                         onclick="filterByStage('${stage.id}')">
                        ${stage.icon} ${stage.label}
                        <span class="stage-count">${count}</span>
                    </div>
                `;
            }).join('');
        }
        
        function filterByStage(stageId) {
            currentStageFilter = stageId;
            renderWorkflowNav();
            renderProjects();
            updatePortfolioDashboard();
        }
        
        function renderProjects() {
            const filtered = currentStageFilter === 'all' 
                ? projects 
                : projects.filter(p => p.status === currentStageFilter);
            
            const grid = document.getElementById('projectGrid');
            
            if (filtered.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: #666;">No projects in this stage</div>';
                return;
            }
            
            grid.innerHTML = filtered.map(project => `
                <div class="project-card ${selectedProjects.has(project.id) ? 'selected' : ''}" data-id="${project.id}">
                    <input type="checkbox" class="card-checkbox" 
                           ${selectedProjects.has(project.id) ? 'checked' : ''}
                           onchange="toggleProjectSelection('${project.id}')">
                    
                    <div class="card-content">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                            <div>
                                <div style="font-size: 0.75rem; color: #666; font-weight: 600;">${project.id}</div>
                                <h3 style="margin: 0.25rem 0 0 0; font-size: 1rem;">${formatScenario(project.scenario)}</h3>
                            </div>
                            <span class="status-badge status-${project.status}">${formatStatus(project.status)}</span>
                        </div>
                        
                        <div class="info-row">
                            <span style="color: #666; font-size: 0.8rem;">üìç Address</span>
                            <span style="font-size: 0.8rem;">${project.address}</span>
                        </div>
                        <div class="info-row">
                            <span style="color: #666; font-size: 0.8rem;">üîß Type</span>
                            <span style="font-size: 0.8rem;">${formatType(project.type)}</span>
                        </div>
                        
                        <div class="card-financials">
                            <div class="mini-financial recommended">
                                <div class="mini-financial-label">Recommended</div>
                                <div class="mini-financial-amount">$${project.financials.recommended.toLocaleString()}</div>
                            </div>
                            <div class="mini-financial selected">
                                <div class="mini-financial-label">Selected</div>
                                <div class="mini-financial-amount">$${project.financials.selected.toLocaleString()}</div>
                            </div>
                            <div class="mini-financial estimated">
                                <div class="mini-financial-label">Estimated</div>
                                <div class="mini-financial-amount">$${project.financials.estimated.toLocaleString()}</div>
                            </div>
                            <div class="mini-financial incentivized">
                                <div class="mini-financial-label">Incentives</div>
                                <div class="mini-financial-amount">$${project.financials.incentivized.toLocaleString()}</div>
                            </div>
                            <div class="mini-financial net" style="grid-column: 1 / -1;">
                                <div class="mini-financial-label">Net Cost</div>
                                <div class="mini-financial-amount" style="font-size: 1.25rem;">$${project.financials.net.toLocaleString()}</div>
                            </div>
                        </div>
                        
                        <div class="card-quick-actions">
                            ${getQuickActions(project)}
                        </div>
                    </div>
                </div>
            `).join('');
            
            updateBulkButtons();
        }
        
        function getQuickActions(project) {
            const actions = {
                'intake': [
                    { label: '‚úÖ Complete Intake', status: 'hea', description: 'Customer qualified, move to HEA' }
                ],
                'hea': [
                    { label: '‚úÖ Complete HEA', status: 'scoping', description: 'Assessment done, start scoping' }
                ],
                'scoping': [
                    { label: 'üìã Manage Measures', action: 'openScoping', primary: true },
                    { label: '‚úÖ Complete Scoping', status: 'bidding', description: 'Measures finalized, request bids' }
                ],
                'bidding': [
                    { label: 'üí∞ Manage Bids', action: 'openBidding', primary: true },
                    { label: '‚úÖ Approve Project', status: 'approved', description: 'Bid selected, approve for work' }
                ],
                'approved': [
                    { label: 'üî® Start Implementation', status: 'implementation', description: 'Begin work on project' }
                ],
                'implementation': [
                    { label: 'üíµ Record Actuals', action: 'openImplementation', primary: true },
                    { label: '‚úÖ Mark Complete', status: 'completed', description: 'Work finished, close project' }
                ],
                'completed': []
            };
            
            const stageActions = actions[project.status] || [];
            
            return stageActions.map(action => {
                if (action.action) {
                    return `<button class="quick-btn ${action.primary ? 'primary' : ''}" onclick="${action.action}('${project.id}')" title="${action.description || ''}">${action.label}</button>`;
                } else {
                    return `<button class="quick-btn" onclick="quickStatusChange('${project.id}', '${action.status}')" title="${action.description || ''}">${action.label}</button>`;
                }
            }).join('');
        }
        
        function quickStatusChange(projectId, newStatus) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            const oldStatus = project.status;
            project.status = newStatus;
            
            ledger.record({
                action: 'STATUS_CHANGE',
                projectId,
                userId: currentUser.id,
                details: { from: oldStatus, to: newStatus }
            });
            
            qaGates.create({
                projectId,
                stage: newStatus,
                inspector: currentUser.id
            });
            
            saveProjects();
            renderWorkflowNav();
            renderProjects();
            updatePortfolioDashboard();
        }
        
        function openScoping(projectId) {
            currentEditingProject = projects.find(p => p.id === projectId);
            if (!currentEditingProject) return;
            
            populateMeasureLibraryDropdown();
            renderMeasureList();
            document.getElementById('scopingModal').classList.add('active');
        }
        
        function populateMeasureLibraryDropdown() {
            const dropdown = document.getElementById('measureLibrary');
            dropdown.innerHTML = '<option value="">Select from measure library...</option>';
            
            const categories = [...new Set(measureLibrary.map(m => m.category))];
            categories.forEach(category => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = category;
                measureLibrary.filter(m => m.category === category).forEach(measure => {
                    const option = document.createElement('option');
                    option.value = JSON.stringify(measure);
                    option.textContent = `${measure.name} ($${measure.typicalCost.toLocaleString()} / $${measure.typicalIncentive.toLocaleString()} incentive)`;
                    optgroup.appendChild(option);
                });
                dropdown.appendChild(optgroup);
            });
        }
        
        function addMeasureFromLibrary() {
            const dropdown = document.getElementById('measureLibrary');
            if (!dropdown.value) return;
            
            const measure = JSON.parse(dropdown.value);
            currentEditingProject.measures.push({
                name: measure.name,
                cost: measure.typicalCost,
                incentive: measure.typicalIncentive,
                selected: false
            });
            
            dropdown.value = '';
            renderMeasureList();
        }
        
        function importMeasures() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if (Array.isArray(imported)) {
                            imported.forEach(m => {
                                if (m.name && (m.cost || m.typicalCost)) {
                                    currentEditingProject.measures.push({
                                        name: m.name,
                                        cost: m.cost || m.typicalCost || 0,
                                        incentive: m.incentive || m.typicalIncentive || 0,
                                        selected: m.selected || false
                                    });
                                }
                            });
                            renderMeasureList();
                            alert(`Imported ${imported.length} measures successfully!`);
                        }
                    } catch (err) {
                        alert('Error importing JSON: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        function exportMeasureLibrary() {
            const data = JSON.stringify(measureLibrary, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'measure-library.json';
            a.click();
        }
        
        function renderMeasureList() {
            const container = document.getElementById('measureList');
            if (!currentEditingProject.measures) currentEditingProject.measures = [];
            
            if (currentEditingProject.measures.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No measures added yet</p>';
            } else {
                container.innerHTML = currentEditingProject.measures.map((m, idx) => `
                    <div class="measure-item">
                        <div>
                            <div class="measure-name">${m.name}</div>
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; font-size: 0.8rem;">
                                <input type="checkbox" ${m.selected ? 'checked' : ''} onchange="toggleMeasureSelection(${idx})">
                                Selected for project
                            </label>
                        </div>
                        <div>
                            <div style="font-size: 0.7rem; color: #666; margin-bottom: 0.25rem;">Cost</div>
                            <input type="number" value="${m.cost}" step="0.01" 
                                   style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; text-align: right;"
                                   onchange="updateMeasureCost(${idx}, this.value)">
                        </div>
                        <div>
                            <div style="font-size: 0.7rem; color: #666; margin-bottom: 0.25rem;">Incentive</div>
                            <input type="number" value="${m.incentive}" step="0.01"
                                   style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; text-align: right;"
                                   onchange="updateMeasureIncentive(${idx}, this.value)">
                        </div>
                        <button class="remove-btn" onclick="removeMeasure(${idx})">‚úï</button>
                    </div>
                `).join('');
            }
            
            updateModalCostSummary();
        }
        
        function addMeasure() {
            const name = prompt('Measure name:', 'New Measure');
            if (!name) return;
            
            currentEditingProject.measures.push({
                name,
                cost: 0,
                incentive: 0,
                selected: false
            });
            
            renderMeasureList();
        }
        
        function removeMeasure(idx) {
            currentEditingProject.measures.splice(idx, 1);
            renderMeasureList();
        }
        
        function toggleMeasureSelection(idx) {
            currentEditingProject.measures[idx].selected = !currentEditingProject.measures[idx].selected;
            updateModalCostSummary();
        }
        
        function updateMeasureCost(idx, value) {
            currentEditingProject.measures[idx].cost = parseFloat(value) || 0;
            updateModalCostSummary();
        }
        
        function updateMeasureIncentive(idx, value) {
            currentEditingProject.measures[idx].incentive = parseFloat(value) || 0;
            updateModalCostSummary();
        }
        
        function updateModalCostSummary() {
            const recommended = currentEditingProject.measures.reduce((sum, m) => sum + m.cost, 0);
            const selected = currentEditingProject.measures.filter(m => m.selected).reduce((sum, m) => sum + m.cost, 0);
            const incentives = currentEditingProject.measures.filter(m => m.selected).reduce((sum, m) => sum + m.incentive, 0);
            const net = selected - incentives;
            
            document.getElementById('modal-recommended').textContent = `$${recommended.toLocaleString()}`;
            document.getElementById('modal-selected').textContent = `$${selected.toLocaleString()}`;
            document.getElementById('modal-incentives').textContent = `$${incentives.toLocaleString()}`;
            document.getElementById('modal-net').textContent = `$${net.toLocaleString()}`;
        }
        
        function saveMeasures() {
            const recommended = currentEditingProject.measures.reduce((sum, m) => sum + m.cost, 0);
            const selected = currentEditingProject.measures.filter(m => m.selected).reduce((sum, m) => sum + m.cost, 0);
            const incentives = currentEditingProject.measures.filter(m => m.selected).reduce((sum, m) => sum + m.incentive, 0);
            
            currentEditingProject.financials.recommended = recommended;
            currentEditingProject.financials.selected = selected;
            currentEditingProject.financials.incentivized = incentives;
            currentEditingProject.financials.net = selected - incentives;
            
            ledger.record({
                action: 'MEASURES_UPDATED',
                projectId: currentEditingProject.id,
                userId: currentUser.id,
                details: { measureCount: currentEditingProject.measures.length, recommended, selected }
            });
            
            saveProjects();
            closeModal('scopingModal');
            renderProjects();
            updatePortfolioDashboard();
        }
        
        function openBidding(projectId) {
            currentEditingProject = projects.find(p => p.id === projectId);
            if (!currentEditingProject) return;
            
            renderBidList();
            document.getElementById('biddingModal').classList.add('active');
        }
        
        function renderBidList() {
            const container = document.getElementById('bidList');
            if (!currentEditingProject.bids) currentEditingProject.bids = [];
            
            if (currentEditingProject.bids.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No bids received yet</p>';
            } else {
                container.innerHTML = currentEditingProject.bids.map((b, idx) => `
                    <div class="bid-item" style="grid-template-columns: 2fr 1fr auto auto;">
                        <div>
                            <div style="font-weight: 600;">${b.contractor}</div>
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; font-size: 0.8rem;">
                                <input type="radio" name="selectedBid" ${b.selected ? 'checked' : ''} onchange="selectBid(${idx})">
                                Selected bid
                            </label>
                        </div>
                        <div>
                            <div style="font-size: 0.7rem; color: #666; margin-bottom: 0.25rem;">Bid Amount</div>
                            <input type="number" value="${b.amount}" step="0.01"
                                   style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; text-align: right;"
                                   onchange="updateBidAmount(${idx}, this.value)">
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.7rem; color: #666;">Status</div>
                            <div style="font-size: 0.8rem; font-weight: 600; color: ${b.selected ? 'var(--success)' : '#666'};">
                                ${b.selected ? '‚úì Selected' : 'Pending'}
                            </div>
                        </div>
                        <button class="remove-btn" onclick="removeBid(${idx})">‚úï</button>
                    </div>
                `).join('');
            }
            
            updateBidModalSummary();
        }
        
        function addBid() {
            const contractor = prompt('Contractor name:', 'ABC Contractors');
            if (!contractor) return;
            
            currentEditingProject.bids.push({
                contractor,
                amount: 0,
                selected: false
            });
            
            renderBidList();
        }
        
        function removeBid(idx) {
            currentEditingProject.bids.splice(idx, 1);
            renderBidList();
        }
        
        function selectBid(idx) {
            currentEditingProject.bids.forEach((b, i) => b.selected = i === idx);
            renderBidList();
        }
        
        function updateBidAmount(idx, value) {
            currentEditingProject.bids[idx].amount = parseFloat(value) || 0;
            updateBidModalSummary();
        }
        
        function updateBidModalSummary() {
            const selectedBid = currentEditingProject.bids.find(b => b.selected);
            const bidAmount = selectedBid ? selectedBid.amount : 0;
            const incentives = currentEditingProject.financials.incentivized;
            const net = bidAmount - incentives;
            
            document.getElementById('modal-bid-selected').textContent = `$${bidAmount.toLocaleString()}`;
            document.getElementById('modal-bid-incentives').textContent = `$${incentives.toLocaleString()}`;
            document.getElementById('modal-bid-net').textContent = `$${net.toLocaleString()}`;
        }
        
        function saveBids() {
            const selectedBid = currentEditingProject.bids.find(b => b.selected);
            if (selectedBid) {
                currentEditingProject.financials.estimated = selectedBid.amount;
                currentEditingProject.financials.net = selectedBid.amount - currentEditingProject.financials.incentivized;
            }
            
            ledger.record({
                action: 'BIDS_UPDATED',
                projectId: currentEditingProject.id,
                userId: currentUser.id,
                details: { bidCount: currentEditingProject.bids.length, selectedAmount: selectedBid?.amount || 0 }
            });
            
            saveProjects();
            closeModal('biddingModal');
            renderProjects();
            updatePortfolioDashboard();
        }
        
        function openImplementation(projectId) {
            currentEditingProject = projects.find(p => p.id === projectId);
            if (!currentEditingProject) return;
            
            document.getElementById('actualCost').value = currentEditingProject.financials.actual || 0;
            document.getElementById('actualIncentives').value = currentEditingProject.financials.incentivized || 0;
            
            updateActualCostsSummary();
            document.getElementById('implementationModal').classList.add('active');
        }
        
        function updateActualCostsSummary() {
            const actual = parseFloat(document.getElementById('actualCost').value) || 0;
            const incentives = parseFloat(document.getElementById('actualIncentives').value) || 0;
            const net = actual - incentives;
            
            document.getElementById('modal-actual').textContent = `$${actual.toLocaleString()}`;
            document.getElementById('modal-actual-incentives').textContent = `$${incentives.toLocaleString()}`;
            document.getElementById('modal-actual-net').textContent = `$${net.toLocaleString()}`;
        }
        
        document.getElementById('actualCost')?.addEventListener('input', updateActualCostsSummary);
        document.getElementById('actualIncentives')?.addEventListener('input', updateActualCostsSummary);
        
        function saveActualCosts() {
            const actual = parseFloat(document.getElementById('actualCost').value) || 0;
            const incentives = parseFloat(document.getElementById('actualIncentives').value) || 0;
            
            currentEditingProject.financials.actual = actual;
            currentEditingProject.financials.incentivized = incentives;
            currentEditingProject.financials.net = actual - incentives;
            
            ledger.record({
                action: 'ACTUAL_COSTS_RECORDED',
                projectId: currentEditingProject.id,
                userId: currentUser.id,
                details: { actual, incentives }
            });
            
            saveProjects();
            closeModal('implementationModal');
            renderProjects();
            updatePortfolioDashboard();
        }
        
        function updatePortfolioDashboard() {
            const filtered = currentStageFilter === 'all' 
                ? projects 
                : projects.filter(p => p.status === currentStageFilter);
            
            const totals = filtered.reduce((acc, p) => {
                acc.recommended += p.financials.recommended;
                acc.selected += p.financials.selected;
                acc.estimated += p.financials.estimated;
                acc.incentivized += p.financials.incentivized;
                acc.net += p.financials.net;
                acc.recommendedCount += (p.measures?.length || 0);
                acc.selectedCount += (p.measures?.filter(m => m.selected).length || 0);
                return acc;
            }, { recommended: 0, selected: 0, estimated: 0, incentivized: 0, net: 0, recommendedCount: 0, selectedCount: 0 });
            
            document.getElementById('portfolioScope').textContent = currentStageFilter === 'all' ? 'All Projects' : `${formatStatus(currentStageFilter)} Stage`;
            document.getElementById('portfolioCount').textContent = filtered.length;
            document.getElementById('portfolio-recommended').textContent = `$${totals.recommended.toLocaleString()}`;
            document.getElementById('portfolio-selected').textContent = `$${totals.selected.toLocaleString()}`;
            document.getElementById('portfolio-estimated').textContent = `$${totals.estimated.toLocaleString()}`;
            document.getElementById('portfolio-incentivized').textContent = `$${totals.incentivized.toLocaleString()}`;
            document.getElementById('portfolio-net').textContent = `$${totals.net.toLocaleString()}`;
            document.getElementById('portfolio-recommended-count').textContent = totals.recommendedCount;
            document.getElementById('portfolio-selected-count').textContent = totals.selectedCount;
        }
        
        function toggleProjectSelection(projectId) {
            if (selectedProjects.has(projectId)) {
                selectedProjects.delete(projectId);
            } else {
                selectedProjects.add(projectId);
            }
            renderProjects();
        }
        
        function toggleSelectAll() {
            const filtered = currentStageFilter === 'all' 
                ? projects 
                : projects.filter(p => p.status === currentStageFilter);
            
            if (selectedProjects.size === filtered.length) {
                selectedProjects.clear();
            } else {
                filtered.forEach(p => selectedProjects.add(p.id));
            }
            renderProjects();
        }
        
        function updateBulkButtons() {
            const count = selectedProjects.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('bulkApproveBtn').disabled = count === 0;
            document.getElementById('bulkExportBtn').disabled = count === 0;
        }
        
        function bulkApprove() {
            selectedProjects.forEach(projectId => {
                quickStatusChange(projectId, 'approved');
            });
            selectedProjects.clear();
        }
        
        function bulkExport() {
            const selected = projects.filter(p => selectedProjects.has(p.id));
            exportProjectsCSV(selected, 'selected-projects');
        }
        
        function exportPortfolio() {
            const filtered = currentStageFilter === 'all' 
                ? projects 
                : projects.filter(p => p.status === currentStageFilter);
            exportProjectsCSV(filtered, `portfolio-${currentStageFilter}`);
        }
        
        function exportProjectsCSV(projectList, filename) {
            const headers = ['ID', 'Type', 'Status', 'Address', 'Recommended', 'Selected', 'Estimated', 'Incentivized', 'Net Cost', 'Measures', 'Bids'];
            const rows = projectList.map(p => [
                p.id,
                p.type,
                p.status,
                p.address,
                p.financials.recommended,
                p.financials.selected,
                p.financials.estimated,
                p.financials.incentivized,
                p.financials.net,
                p.measures?.length || 0,
                p.bids?.length || 0
            ]);
            
            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        
        function openNewProjectModal() {
            document.getElementById('projectModal').classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        document.getElementById('projectForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newProject = {
                id: 'CPF-' + String(projects.length + 1).padStart(3, '0'),
                type: document.getElementById('projectType').value,
                scenario: document.getElementById('customerScenario').value,
                address: document.getElementById('address').value,
                status: 'intake',
                qualified: document.getElementById('qualified').value,
                form300: false,
                form320: false,
                measures: [],
                bids: [],
                financials: {
                    recommended: 0,
                    selected: 0,
                    estimated: 0,
                    incentivized: 0,
                    net: 0,
                    actual: 0
                },
                createdDate: new Date().toISOString()
            };
            
            projects.push(newProject);
            
            ledger.record({
                action: 'PROJECT_CREATED',
                projectId: newProject.id,
                userId: currentUser.id,
                details: { type: newProject.type, scenario: newProject.scenario }
            });
            
            saveProjects();
            renderWorkflowNav();
            renderProjects();
            updatePortfolioDashboard();
            closeModal('projectModal');
        });
        
        function saveProjects() {
            localStorage.setItem('cpf_projects_financial', JSON.stringify(projects));
        }
        
        function formatType(type) {
            return type.split('-').map(w => w[0].toUpperCase() + w.slice(1)).join(' ');
        }
        
        function formatScenario(scenario) {
            return scenario.split('-').map(w => w[0].toUpperCase() + w.slice(1)).join(' ');
        }
        
        function formatStatus(status) {
            return status.split('-').map(w => w[0].toUpperCase() + w.slice(1)).join(' ');
        }
        
        init();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPF Project Tracker - Financial Management Suite</title>
    
    <!-- Core Modules -->
    <script src="../../core/ledger.js"></script>
    <script src="../../core/rbac.js"></script>
    <script src="../../core/approval-engine.js"></script>
    <script src="../../core/funding-tracker.js"></script>
    <script src="../../core/qa-gates.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --primary: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --purple: #7c3aed;
            --bg: #f8fafc;
            --text: #1e293b;
            --border: #e2e8f0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, var(--primary), #1e40af);
            color: white;
            padding: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .header h1 { font-size: 1.5rem; margin-bottom: 0.25rem; }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        
        /* Portfolio Dashboard */
        .portfolio-dashboard {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .financial-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .financial-card {
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid;
        }
        
        .financial-card.recommended { background: #f3e8ff; border-color: var(--purple); }
        .financial-card.selected { background: #dbeafe; border-color: var(--primary); }
        .financial-card.estimated { background: #fef3c7; border-color: var(--warning); }
        .financial-card.incentivized { background: #d1fae5; border-color: var(--success); }
        .financial-card.net { background: #fee2e2; border-color: var(--danger); }
        
        .financial-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 600;
            color: #666;
            margin-bottom: 0.25rem;
        }
        
        .financial-amount {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }
        
        .financial-count {
            font-size: 0.875rem;
            color: #666;
        }
        
        /* Workflow Navigator */
        .workflow-nav {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        /* Ledger Entries */
        .ledger-entry {
            background: white;
            border-left: 4px solid var(--primary);
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 6px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.875rem;
        }
        
        .ledger-entry.PROJECT_CREATED { border-color: var(--success); }
        .ledger-entry.STATUS_CHANGE { border-color: var(--primary); }
        .ledger-entry.MEASURES_UPDATED { border-color: var(--warning); }
        .ledger-entry.BIDS_UPDATED { border-color: var(--warning); }
        .ledger-entry.FUNDING_UPDATED { border-color: var(--purple); }
        .ledger-entry.ACTUALS_RECORDED { border-color: var(--danger); }
        
        .ledger-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .ledger-timestamp {
            color: #666;
            font-size: 0.75rem;
        }
        
        .ledger-details {
            color: #666;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: #f8fafc;
            border-radius: 4px;
        }
        
        .ledger-hash {
            color: #999;
            font-size: 0.7rem;
            margin-top: 0.5rem;
            word-break: break-all;
        }
        
        /* Task Cards */
        .task-card {
            background: white;
            border-left: 4px solid var(--primary);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.75rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .task-card.high-priority { border-color: var(--danger); }
        .task-card.medium-priority { border-color: var(--warning); }
        .task-card.low-priority { border-color: var(--success); }
        
        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 0.75rem;
        }
        
        .task-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.25rem;
        }
        
        .task-project {
            font-size: 0.8rem;
            color: #666;
        }
        
        .task-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
        }
        
        .task-badge.urgent { background: #fee2e2; color: var(--danger); }
        .task-badge.normal { background: #fef3c7; color: var(--warning); }
        .task-badge.low { background: #d1fae5; color: var(--success); }
        
        .task-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        
        .task-dependency {
            font-size: 0.75rem;
            color: #666;
            padding: 0.5rem;
            background: #f8fafc;
            border-radius: 4px;
            margin-top: 0.5rem;
        }
        
        .workflow-stages {
            display: flex;
            gap: 0.5rem;
            overflow-x: auto;
            padding: 0.5rem 0;
        }
        
        .stage-chip {
            padding: 0.75rem 1.25rem;
            border-radius: 24px;
            border: 2px solid var(--border);
            background: white;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        .stage-chip:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .stage-chip.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .stage-count {
            background: rgba(0,0,0,0.1);
            padding: 0.2rem 0.5rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .stage-chip.active .stage-count {
            background: rgba(255,255,255,0.3);
        }
        
        /* Quick Actions */
        .quick-actions {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .btn {
            padding: 0.625rem 1.25rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-secondary { background: var(--border); color: var(--text); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .select-all-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            border-right: 1px solid var(--border);
            margin-right: 0.5rem;
        }
        
        .checkbox-custom {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* Project Grid */
        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(450px, 1fr));
            gap: 1.25rem;
        }
        
        .project-card {
            background: white;
            border-radius: 12px;
            padding: 1.25rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid var(--primary);
            transition: all 0.2s;
            position: relative;
        }
        
        .project-card.selected {
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
            border-left-width: 6px;
        }
        
        .project-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .card-checkbox {
            position: absolute;
            top: 1rem;
            left: 1rem;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .card-content {
            margin-left: 2rem;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-intake { background: #dbeafe; color: #1e40af; }
        .status-hea { background: #fef3c7; color: #92400e; }
        .status-scoping { background: #fce7f3; color: #9f1239; }
        .status-bidding { background: #e0e7ff; color: #3730a3; }
        .status-approved { background: #d1fae5; color: #065f46; }
        .status-implementation { background: #dbeafe; color: #1e40af; }
        .status-completed { background: #d1fae5; color: #065f46; }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border);
            font-size: 0.875rem;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        /* Financial Display on Cards */
        .card-financials {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin: 1rem 0;
            padding: 1rem;
            background: var(--bg);
            border-radius: 8px;
        }
        
        .mini-financial {
            text-align: center;
        }
        
        .mini-financial-label {
            font-size: 0.625rem;
            text-transform: uppercase;
            color: #666;
            font-weight: 600;
        }
        
        .mini-financial-amount {
            font-size: 1rem;
            font-weight: 700;
            margin-top: 0.25rem;
        }
        
        .mini-financial.recommended .mini-financial-amount { color: var(--purple); }
        .mini-financial.selected .mini-financial-amount { color: var(--primary); }
        .mini-financial.estimated .mini-financial-amount { color: var(--warning); }
        .mini-financial.incentivized .mini-financial-amount { color: var(--success); }
        .mini-financial.net .mini-financial-amount { color: var(--danger); }
        
        /* Quick Action Buttons */
        .card-quick-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .quick-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--border);
            border-radius: 6px;
            background: white;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .quick-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .quick-btn.primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active { display: flex; }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            max-width: 900px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .form-group {
            margin-bottom: 1.25rem;
        }
        
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.875rem;
        }
        
        .form-group input[type="number"] {
            text-align: right;
        }
        
        /* Measure/Bid List */
        .measure-list, .bid-list {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            background: var(--bg);
        }
        
        .measure-item, .bid-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr auto;
            gap: 1rem;
            align-items: center;
            padding: 0.75rem;
            background: white;
            border-radius: 6px;
            margin-bottom: 0.75rem;
            border: 1px solid var(--border);
        }
        
        .measure-item:last-child, .bid-item:last-child {
            margin-bottom: 0;
        }
        
        .measure-name {
            font-weight: 600;
        }
        
        .measure-cost, .bid-cost {
            text-align: right;
            font-weight: 700;
            color: var(--primary);
        }
        
        .measure-incentive {
            text-align: right;
            font-weight: 700;
            color: var(--success);
        }
        
        .remove-btn {
            background: var(--danger);
            color: white;
            border: none;
            padding: 0.5rem 0.75rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
        }
        
        .add-measure-btn, .add-bid-btn {
            width: 100%;
            padding: 0.75rem;
            background: var(--border);
            border: 2px dashed #999;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            margin-top: 0.75rem;
        }
        
        .add-measure-btn:hover, .add-bid-btn:hover {
            background: #ddd;
            border-color: var(--primary);
            color: var(--primary);
        }
        
        /* Cost Summary in Modal */
        .cost-summary {
            background: var(--bg);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1.5rem 0;
        }
        
        .cost-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            font-size: 0.875rem;
        }
        
        .cost-row.total {
            border-top: 2px solid var(--border);
            margin-top: 0.5rem;
            padding-top: 1rem;
            font-size: 1.125rem;
            font-weight: 700;
        }
        
        .cost-amount {
            font-weight: 700;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 22px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .3s;
            border-radius: 22px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .3s;
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--success);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }
        
        .two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .three-col {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>üíº CPF Project Tracker - Financial Management Suite</h1>
                    <p style="opacity: 0.9; font-size: 0.875rem;">Comprehensive cost tracking with stage-specific workflows</p>
                </div>
                <div style="background: rgba(255,255,255,0.2); padding: 0.75rem 1.5rem; border-radius: 8px; min-width: 250px;">
                    <label style="font-size: 0.75rem; opacity: 0.9; display: block; margin-bottom: 0.25rem;">Current Role</label>
                    <select id="roleSelector" onchange="changeRole()" style="width: 100%; padding: 0.5rem; border: none; border-radius: 6px; font-size: 0.9rem; font-weight: 600; background: white;">
                        <option value="all">All Roles (Admin View)</option>
                        <option value="pm">Project Manager</option>
                        <option value="finance">Finance Director</option>
                        <option value="coordinator">Program Coordinator</option>
                        <option value="qa">QA Inspector</option>
                        <option value="contractor">Contractor</option>
                        <option value="customer">Customer</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container">
        <!-- Role-Specific Tasks Dashboard -->
        <div id="roleDashboard" style="background: white; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: none;">
            <h3 style="margin-bottom: 0.5rem;">üìù My Pending Tasks</h3>
            <p style="font-size: 0.875rem; color: #666; margin-bottom: 1rem;" id="taskSummary"></p>
            <div id="pendingTasks"></div>
        </div>
        
        <!-- Portfolio Financial Dashboard -->
        <div class="portfolio-dashboard">
            <h3 style="margin-bottom: 0.5rem;">üìä Portfolio Financial Summary</h3>
            <p style="font-size: 0.875rem; color: #666; margin-bottom: 1rem;">
                <span id="portfolioScope">All Projects</span> ‚Ä¢ 
                <span id="portfolioCount">0</span> projects
            </p>
            <div class="financial-summary">
                <div class="financial-card recommended">
                    <div class="financial-label">Recommended Total</div>
                    <div class="financial-amount" id="portfolio-recommended">$0</div>
                    <div class="financial-count"><span id="portfolio-recommended-count">0</span> measures</div>
                </div>
                <div class="financial-card selected">
                    <div class="financial-label">Selected Total</div>
                    <div class="financial-amount" id="portfolio-selected">$0</div>
                    <div class="financial-count"><span id="portfolio-selected-count">0</span> measures</div>
                </div>
                <div class="financial-card estimated">
                    <div class="financial-label">Estimated Cost</div>
                    <div class="financial-amount" id="portfolio-estimated">$0</div>
                    <div class="financial-count">Contractor estimates</div>
                </div>
                <div class="financial-card incentivized">
                    <div class="financial-label">Total Incentives</div>
                    <div class="financial-amount" id="portfolio-incentivized">$0</div>
                    <div class="financial-count">Rebates & credits</div>
                </div>
                <div class="financial-card net">
                    <div class="financial-label">Net Cost</div>
                    <div class="financial-amount" id="portfolio-net">$0</div>
                    <div class="financial-count">After incentives</div>
                </div>
            </div>
        </div>
        
        <!-- Workflow Navigator -->
        <div class="workflow-nav">
            <div class="workflow-stages" id="workflowStages"></div>
        </div>
        
        <!-- Quick Actions -->
            <div class="quick-actions" id="quickActionsBar">
                <div class="select-all-container" id="selectAllContainer">
                    <input type="checkbox" id="selectAll" class="checkbox-custom" onchange="toggleSelectAll()">
                    <label for="selectAll" style="cursor: pointer; font-size: 0.875rem;">Select All</label>
                </div>
                
                <button class="btn btn-primary" id="newProjectBtn" onclick="openNewProjectModal()">
                    ‚û°Ô∏è New Project
                </button>
                
                <button class="btn btn-success" id="bulkApproveBtn" onclick="bulkApprove()" disabled>
                    ‚úÖ Bulk Approve
                </button>
                
                <button class="btn btn-secondary" id="bulkExportBtn" onclick="bulkExport()" disabled>
                    üì• Export Selected
                </button>
                
                <button class="btn btn-secondary" onclick="exportPortfolio()">
                    üìä Export Portfolio
                </button>
                
                <button class="btn btn-secondary" onclick="openLedger()" title="View immutable transaction ledger">
                    üìí View Ledger
                </button>
                
                <div style="margin-left: auto; font-size: 0.875rem; color: #666;">
                    <span id="selectedCount">0</span> selected
                </div>
            </div>
        
        <!-- Project Grid -->
        <div class="project-grid" id="projectGrid"></div>
    </div>
    
    <!-- New Project Modal -->
    <div class="modal" id="projectModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>New Project</h2>
                <button class="modal-close" onclick="closeModal('projectModal')">√ó</button>
            </div>
            <form id="projectForm">
                <div class="two-col">
                    <div class="form-group">
                        <label>Project Type *</label>
                        <select id="projectType" required>
                            <option value="">Select type...</option>
                            <option value="weatherization">Weatherization</option>
                            <option value="heat-pump">Heat Pump Installation</option>
                            <option value="solar">Solar Installation</option>
                            <option value="insulation">Insulation Upgrade</option>
                            <option value="hvac">HVAC Replacement</option>
                            <option value="windows">Window Replacement</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Customer Scenario *</label>
                        <select id="customerScenario" required>
                            <option value="">Select scenario...</option>
                            <option value="low-income-homeowner">Low-Income Homeowner</option>
                            <option value="moderate-income-homeowner">Moderate-Income Homeowner</option>
                            <option value="renter-with-permission">Renter (with permission)</option>
                            <option value="landlord-owner">Landlord/Property Owner</option>
                            <option value="manufactured-home">Manufactured Home Owner</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Address *</label>
                    <input type="text" id="address" placeholder="123 Main St, Portland OR" required>
                </div>
                
                <div class="form-group">
                    <label>Income Qualification Status</label>
                    <select id="qualified">
                        <option value="pending">‚è≥ Pending Verification</option>
                        <option value="yes">‚úÖ Qualified</option>
                        <option value="no">‚ùå Not Qualified - Refer</option>
                    </select>
                </div>
                
                <div style="display: flex; gap: 1rem;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('projectModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Project</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Scoping/Measures Modal -->
    <div class="modal" id="scopingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìê Scoping & Measures</h2>
                <button class="modal-close" onclick="closeModal('scopingModal')">√ó</button>
            </div>
            
            <p style="margin-bottom: 1rem; color: #666;">Add recommended and selected measures with estimated costs and incentives.</p>
            
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                <select id="measureLibrary" style="flex: 1; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px;">
                    <option value="">Select from measure library...</option>
                </select>
                <button class="btn btn-primary" onclick="addMeasureFromLibrary()" style="white-space: nowrap;">+ Add Selected</button>
                <button class="btn btn-secondary" onclick="importMeasures()" title="Import JSON">üì• Import</button>
                <button class="btn btn-secondary" onclick="exportMeasureLibrary()" title="Export Library">üì§ Export</button>
            </div>
            
            <div class="measure-list" id="measureList"></div>
            
            <!-- Funding Sources in Scoping -->
            <div style="border-top: 2px solid var(--border); margin-top: 1.5rem; padding-top: 1.5rem;">
                <h3 style="margin-bottom: 0.75rem; font-size: 1rem;">üí∞ Funding Sources (Braided/Stacked)</h3>
                <p style="font-size: 0.875rem; color: #666; margin-bottom: 1rem;">Add multiple funding sources to maximize incentives</p>
                
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <select id="scopingFundingLibrary" style="flex: 1; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px;">
                        <option value="">Select funding source...</option>
                    </select>
                    <button class="btn btn-primary" onclick="addFundingToScoping()" style="white-space: nowrap;">+ Add Source</button>
                </div>
                
                <div id="scopingFundingList" style="margin-bottom: 1rem;"></div>
            </div>
            
            <div class="cost-summary">
                <div class="cost-row">
                    <span>Recommended Total:</span>
                    <span class="cost-amount" id="modal-recommended">$0</span>
                </div>
                <div class="cost-row">
                    <span>Selected Total:</span>
                    <span class="cost-amount" id="modal-selected">$0</span>
                </div>
                <div class="cost-row">
                    <span>Total Incentives (All Sources):</span>
                    <span class="cost-amount" style="color: var(--success);" id="modal-incentives">$0</span>
                </div>
                <div class="cost-row total">
                    <span>Net Cost (Selected - Incentives):</span>
                    <span class="cost-amount" style="color: var(--danger);" id="modal-net">$0</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('scopingModal')">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveMeasures()">üíæ Save Measures & Funding</button>
            </div>
        </div>
    </div>
    
    <!-- Bidding Modal -->
    <div class="modal" id="biddingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí∞ Contractor Bids</h2>
                <button class="modal-close" onclick="closeModal('biddingModal')">√ó</button>
            </div>
            
            <p style="margin-bottom: 1rem; color: #666;">Collect and compare contractor bids for selected measures.</p>
            
            <div class="bid-list" id="bidList"></div>
            
            <button class="add-bid-btn" onclick="addBid()">+ Add Contractor Bid</button>
            
            <div class="cost-summary">
                <div class="cost-row">
                    <span>Selected Bid:</span>
                    <span class="cost-amount" id="modal-bid-selected">$0</span>
                </div>
                <div class="cost-row">
                    <span>Total Incentives:</span>
                    <span class="cost-amount" style="color: var(--success);" id="modal-bid-incentives">$0</span>
                </div>
                <div class="cost-row total">
                    <span>Net Cost:</span>
                    <span class="cost-amount" style="color: var(--danger);" id="modal-bid-net">$0</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('biddingModal')">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveBids()">üíæ Save Bids</button>
            </div>
        </div>
    </div>
    
    <!-- Funding Sources Modal -->
    <div class="modal" id="fundingModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üí∞ Funding Sources (Braided/Stacked)</h2>
                <button class="modal-close" onclick="closeModal('fundingModal')">√ó</button>
            </div>
            
            <p style="margin-bottom: 1rem; color: #666;">Layer multiple funding sources to cover project costs. Total incentives are automatically calculated.</p>
            
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                <select id="fundingSourceLibrary" style="flex: 1; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px;">
                    <option value="">Select funding source...</option>
                </select>
                <button class="btn btn-primary" onclick="addFundingSourceFromLibrary()" style="white-space: nowrap;">+ Add Source</button>
            </div>
            
            <div class="measure-list" id="fundingSourceList"></div>
            
            <div class="cost-summary">
                <div class="cost-row">
                    <span>Project Cost (Selected Measures):</span>
                    <span class="cost-amount" id="modal-funding-cost">$0</span>
                </div>
                <div class="cost-row">
                    <span>Total Incentives (All Sources):</span>
                    <span class="cost-amount" style="color: var(--success);" id="modal-funding-incentives">$0</span>
                </div>
                <div class="cost-row total">
                    <span>Net Cost to Customer:</span>
                    <span class="cost-amount" style="color: var(--danger);" id="modal-funding-net">$0</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('fundingModal')">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveFundingSources()">üíæ Save Funding Stack</button>
            </div>
        </div>
    </div>
    
    <!-- Form Approval Modal (300CPF/320CPF) -->
    <div class="modal" id="formApprovalModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>üìã CPF Form Approvals (300/320)</h2>
                <button class="modal-close" onclick="closeModal('formApprovalModal')">√ó</button>
            </div>
            
            <p style="margin-bottom: 1rem; color: #666;">Manage 300CPF (Project Authorization) and 320CPF (Payment Request) form approvals with multi-party verification.</p>
            
            <div id="formApprovalProjectInfo" style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; font-size: 0.875rem;"></div>
            
            <!-- 300CPF Form Section -->
            <div style="border: 2px solid var(--primary); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="font-size: 1rem; margin: 0;">üìÑ 300CPF - Project Authorization Form</h3>
                    <div id="form300Status" style="font-weight: 600; padding: 0.5rem 1rem; border-radius: 6px;"></div>
                </div>
                
                <div style="background: #f8fafc; padding: 0.75rem; border-radius: 6px; margin-bottom: 0.75rem; font-size: 0.85rem;">
                    <strong>Required for:</strong> Project authorization, contractor selection, work commencement<br>
                    <strong>Approvers:</strong> Program Coordinator, Finance Director
                </div>
                
                <div id="form300Approvers"></div>
                
                <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                    <button class="btn btn-success" id="form300ApproveBtn" onclick="approveForm('300')" style="flex: 1;">‚úÖ Approve 300CPF</button>
                    <button class="btn btn-secondary" onclick="requestForm300Revision()">üîÑ Request Revision</button>
                </div>
            </div>
            
            <!-- 320CPF Form Section -->
            <div style="border: 2px solid var(--success); border-radius: 8px; padding: 1rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 style="font-size: 1rem; margin: 0;">üíµ 320CPF - Payment Request Form</h3>
                    <div id="form320Status" style="font-weight: 600; padding: 0.5rem 1rem; border-radius: 6px;"></div>
                </div>
                
                <div style="background: #f8fafc; padding: 0.75rem; border-radius: 6px; margin-bottom: 0.75rem; font-size: 0.85rem;">
                    <strong>Required for:</strong> Payment disbursement, work completion verification<br>
                    <strong>Approvers:</strong> QA Inspector, Finance Director, Program Coordinator
                </div>
                
                <div id="form320Approvers"></div>
                
                <div style="display: flex; gap: 0.5rem; margin-top: 0.75rem;">
                    <button class="btn btn-success" id="form320ApproveBtn" onclick="approveForm('320')" style="flex: 1;" disabled>‚úÖ Approve 320CPF</button>
                    <button class="btn btn-secondary" onclick="requestForm320Revision()" disabled>üîÑ Request Revision</button>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('formApprovalModal')">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Decision Points Modal -->
    <div class="modal" id="decisionModal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2>üéØ Decision Points & Routing</h2>
                <button class="modal-close" onclick="closeModal('decisionModal')">√ó</button>
            </div>
            
            <p style="margin-bottom: 1rem; color: #666;">Critical decision points with routing logic and escalation paths.</p>
            
            <div id="decisionProjectInfo" style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; font-size: 0.875rem;"></div>
            
            <div id="decisionPointsList"></div>
            
            <div style="border-top: 1px solid var(--border); padding-top: 1rem; margin-top: 1rem;">
                <h3 style="font-size: 0.9rem; margin-bottom: 0.75rem; font-weight: 600;">Add Decision Point</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <div>
                        <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 0.25rem;">Decision Type</label>
                        <select id="decisionType" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px;">
                            <option value="">Select type...</option>
                            <option value="Qualified Homeowner">Qualified Homeowner</option>
                            <option value="Resources Check">Resources Check</option>
                            <option value="Budget Threshold">Budget Threshold</option>
                            <option value="Scope Change">Scope Change</option>
                            <option value="Quality Issue">Quality Issue</option>
                            <option value="Timeline Delay">Timeline Delay</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 0.25rem;">Decision</label>
                        <select id="decisionOutcome" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px;">
                            <option value="">Select outcome...</option>
                            <option value="Approved">Approved - Continue</option>
                            <option value="Escalated">Escalated - Review Required</option>
                            <option value="Denied">Denied - Refer Out</option>
                            <option value="On Hold">On Hold - Pending Info</option>
                        </select>
                    </div>
                </div>
                <div style="margin-bottom: 0.5rem;">
                    <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 0.25rem;">Notes/Reasoning</label>
                    <textarea id="decisionNotes" rows="2" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px; font-family: inherit;" placeholder="Document reasoning for decision..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="addDecisionPoint()" style="width: 100%;">+ Add Decision</button>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('decisionModal')">Close</button>
                <button type="button" class="btn btn-success" onclick="saveDecisions()">üíæ Save Decisions</button>
            </div>
        </div>
    </div>
    
    <!-- Approval/Verification Modal -->
    <div class="modal" id="approvalModal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2>‚úÖ Multi-Party Approval & Verification</h2>
                <button class="modal-close" onclick="closeModal('approvalModal')">√ó</button>
            </div>
            
            <p style="margin-bottom: 1rem; color: #666;">Track approvals and verifications from multiple stakeholders for this project.</p>
            
            <div id="approvalProjectInfo" style="background: #f8fafc; padding: 1rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.875rem;"></div>
            
            <div style="margin-bottom: 1.5rem;">
                <h3 style="font-size: 0.9rem; margin-bottom: 0.75rem; font-weight: 600;">Required Approvals</h3>
                <div id="approvalsList"></div>
            </div>
            
            <div style="border-top: 1px solid var(--border); padding-top: 1rem; margin-top: 1rem;">
                <h3 style="font-size: 0.9rem; margin-bottom: 0.75rem; font-weight: 600;">Add Approval/Verification</h3>
                <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 0.5rem; align-items: end;">
                    <div>
                        <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 0.25rem;">Party/Role</label>
                        <select id="approvalParty" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px;">
                            <option value="">Select party...</option>
                            <option value="Project Manager">Project Manager</option>
                            <option value="Finance Director">Finance Director</option>
                            <option value="Program Coordinator">Program Coordinator</option>
                            <option value="QA Inspector">QA Inspector</option>
                            <option value="Customer">Customer</option>
                            <option value="Contractor">Contractor</option>
                            <option value="Funding Administrator">Funding Administrator</option>
                        </select>
                    </div>
                    <div>
                        <label style="font-size: 0.8rem; color: #666; display: block; margin-bottom: 0.25rem;">Stage/Checkpoint</label>
                        <select id="approvalStage" style="width: 100%; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px;">
                            <option value="">Select stage...</option>
                            <option value="Scoping Complete">Scoping Complete</option>
                            <option value="Budget Approved">Budget Approved</option>
                            <option value="Contractor Selected">Contractor Selected</option>
                            <option value="Work Order Signed">Work Order Signed</option>
                            <option value="Work Inspected">Work Inspected</option>
                            <option value="Final Inspection">Final Inspection</option>
                            <option value="Funding Disbursed">Funding Disbursed</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="addApproval()" style="white-space: nowrap;">+ Add</button>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('approvalModal')">Close</button>
                <button type="button" class="btn btn-success" onclick="saveApprovals()">üíæ Save Approvals</button>
            </div>
        </div>
    </div>
    
    <!-- Ledger Modal -->
    <div class="modal" id="ledgerModal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="modal-header">
                <h2>üìí Transaction Ledger (Immutable Audit Trail)</h2>
                <button class="modal-close" onclick="closeModal('ledgerModal')">√ó</button>
            </div>
            
            <p style="margin-bottom: 1rem; color: #666;">All project transactions and state changes are recorded here with cryptographic hashing for audit compliance.</p>
            
            <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                <select id="ledgerFilterProject" onchange="renderLedger()" style="flex: 1; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px;">
                    <option value="">All Projects</option>
                </select>
                <select id="ledgerFilterAction" onchange="renderLedger()" style="flex: 1; padding: 0.75rem; border: 1px solid var(--border); border-radius: 6px;">
                    <option value="">All Actions</option>
                    <option value="PROJECT_CREATED">Project Created</option>
                    <option value="STATUS_CHANGE">Status Changes</option>
                    <option value="MEASURES_UPDATED">Measures Updated</option>
                    <option value="BIDS_UPDATED">Bids Updated</option>
                    <option value="FUNDING_UPDATED">Funding Updated</option>
                    <option value="ACTUALS_RECORDED">Actuals Recorded</option>
                </select>
                <button class="btn btn-secondary" onclick="exportLedger()" title="Export Ledger">üì• Export</button>
            </div>
            
            <div id="ledgerEntries" style="max-height: 500px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 1rem; background: #f8fafc;"></div>
            
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('ledgerModal')">Close</button>
            </div>
        </div>
    </div>
    
    <!-- Implementation/Actual Costs Modal -->
    <div class="modal" id="implementationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üî® Implementation & Actual Costs</h2>
                <button class="modal-close" onclick="closeModal('implementationModal')">√ó</button>
            </div>
            
            <div class="form-group">
                <label>Actual Project Cost</label>
                <input type="number" id="actualCost" placeholder="0.00" step="0.01">
            </div>
            
            <!-- Funding Sources Update in Implementation -->
            <div style="border: 1px solid var(--border); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; background: #f8fafc;">
                <h3 style="margin-bottom: 0.75rem; font-size: 0.9rem; font-weight: 600;">üí∞ Update Funding Sources (Actuals)</h3>
                <p style="font-size: 0.8rem; color: #666; margin-bottom: 0.75rem;">Adjust incentive amounts based on actual disbursements</p>
                <div id="implementationFundingList"></div>
            </div>
            
            <div class="cost-summary">
                <div class="cost-row">
                    <span>Actual Cost:</span>
                    <span class="cost-amount" id="modal-actual">$0</span>
                </div>
                <div class="cost-row">
                    <span>Incentives Applied:</span>
                    <span class="cost-amount" style="color: var(--success);" id="modal-actual-incentives">$0</span>
                </div>
                <div class="cost-row total">
                    <span>Net Cost to Customer:</span>
                    <span class="cost-amount" style="color: var(--danger);" id="modal-actual-net">$0</span>
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('implementationModal')">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveActualCosts()">üíæ Save Actual Costs</button>
            </div>
        </div>
    </div>
    
    <script>
        // Funding Sources Library - Pre-defined incentive sources
        const fundingSourcesLibrary = [
            { name: 'Energy Trust of Oregon', category: 'Utility', type: 'Rebate', maxAmount: null, description: 'Electric utility rebates' },
            { name: 'NW Natural Rebates', category: 'Utility', type: 'Rebate', maxAmount: null, description: 'Gas utility rebates' },
            { name: 'Federal Tax Credit (25C)', category: 'Tax Credit', type: 'Tax Credit', maxAmount: 1200, description: 'Home efficiency improvements' },
            { name: 'Federal Tax Credit (25D)', category: 'Tax Credit', type: 'Tax Credit', maxAmount: null, description: '30% solar/battery credit' },
            { name: 'Oregon Residential Energy Tax Credit', category: 'Tax Credit', type: 'Tax Credit', maxAmount: 1500, description: 'State tax credit' },
            { name: 'Weatherization Assistance Program (WAP)', category: 'Federal Program', type: 'Grant', maxAmount: 8000, description: 'DOE weatherization' },
            { name: 'LIHEAP', category: 'Federal Program', type: 'Grant', maxAmount: 5000, description: 'Low-income heating assistance' },
            { name: 'Community Action Agency Funding', category: 'Community', type: 'Grant', maxAmount: null, description: 'Local CAA programs' },
            { name: 'Habitat for Humanity', category: 'Nonprofit', type: 'Grant', maxAmount: null, description: 'Home repair assistance' },
            { name: 'Internal CPF Funding', category: 'Internal', type: 'Grant', maxAmount: null, description: 'Organization gap funding' },
            { name: 'Green Bank Financing', category: 'Financing', type: 'Loan', maxAmount: null, description: 'Clean energy loans' },
            { name: 'PACE Financing', category: 'Financing', type: 'Loan', maxAmount: null, description: 'Property-assessed clean energy' },
            { name: 'Inflation Reduction Act - HOMES', category: 'Federal Program', type: 'Rebate', maxAmount: 8000, description: 'Whole-home performance rebates' },
            { name: 'Inflation Reduction Act - HEAR', category: 'Federal Program', type: 'Rebate', maxAmount: 14000, description: 'Electrification rebates' },
            { name: 'State Affordable Housing Credits', category: 'State Program', type: 'Grant', maxAmount: null, description: 'Housing assistance' },
            { name: 'Tribal Energy Programs', category: 'Tribal', type: 'Grant', maxAmount: null, description: 'Tribal member assistance' },
            { name: 'Veterans Affairs Benefits', category: 'Federal Program', type: 'Grant', maxAmount: null, description: 'VA home improvement' },
            { name: 'HUD Home Improvement', category: 'Federal Program', type: 'Grant', maxAmount: null, description: 'HUD rehabilitation programs' },
            { name: 'Local Government Grants', category: 'Municipal', type: 'Grant', maxAmount: null, description: 'City/county programs' },
            { name: 'Foundation Grants', category: 'Nonprofit', type: 'Grant', maxAmount: null, description: 'Private foundation funding' }
        ];
        
        // Measure Library - Pre-defined measures with typical costs and incentives
        const measureLibrary = [
            { name: 'Attic Insulation (R-38)', category: 'Insulation', typicalCost: 2500, typicalIncentive: 500 },
            { name: 'Wall Insulation', category: 'Insulation', typicalCost: 3500, typicalIncentive: 700 },
            { name: 'Floor Insulation', category: 'Insulation', typicalCost: 2000, typicalIncentive: 400 },
            { name: 'Air Sealing & Weatherization', category: 'Weatherization', typicalCost: 1500, typicalIncentive: 300 },
            { name: 'Duct Sealing & Insulation', category: 'Weatherization', typicalCost: 1200, typicalIncentive: 250 },
            { name: 'Heat Pump (Mini-Split)', category: 'HVAC', typicalCost: 8000, typicalIncentive: 2000 },
            { name: 'Heat Pump (Ducted)', category: 'HVAC', typicalCost: 12000, typicalIncentive: 3000 },
            { name: 'Heat Pump Water Heater', category: 'Water Heating', typicalCost: 3500, typicalIncentive: 1000 },
            { name: 'Solar Water Heater', category: 'Water Heating', typicalCost: 5500, typicalIncentive: 1500 },
            { name: 'Windows - Double Pane (per window)', category: 'Windows', typicalCost: 650, typicalIncentive: 100 },
            { name: 'Windows - Triple Pane (per window)', category: 'Windows', typicalCost: 900, typicalIncentive: 150 },
            { name: 'Solar PV System (5kW)', category: 'Solar', typicalCost: 15000, typicalIncentive: 4500 },
            { name: 'Solar PV System (10kW)', category: 'Solar', typicalCost: 25000, typicalIncentive: 7500 },
            { name: 'Electric Panel Upgrade (200A)', category: 'Electrical', typicalCost: 2500, typicalIncentive: 500 },
            { name: 'LED Lighting Upgrade (whole home)', category: 'Lighting', typicalCost: 800, typicalIncentive: 200 },
            { name: 'Smart Thermostat', category: 'Controls', typicalCost: 250, typicalIncentive: 75 },
            { name: 'Refrigerator (ENERGY STAR)', category: 'Appliances', typicalCost: 1200, typicalIncentive: 200 },
            { name: 'Clothes Washer (ENERGY STAR)', category: 'Appliances', typicalCost: 800, typicalIncentive: 150 },
            { name: 'Clothes Dryer - Heat Pump', category: 'Appliances', typicalCost: 1400, typicalIncentive: 300 }
        ];
        
        // Initialize core modules
        const ledger = new Ledger({ storageKey: 'cpf_ledger_financial' });
        const rbac = new RBAC();
        const approvals = new ApprovalEngine();
        const funding = new FundingTracker();
        const qaGates = new QAGates();
        
        const currentUser = { id: 'pm_john', name: 'John PM', role: 'pm' };
        
        let projects = JSON.parse(localStorage.getItem('cpf_projects_financial') || '[]');
        let selectedProjects = new Set();
        let currentStageFilter = 'all';
        let currentEditingProject = null;
        let currentRole = localStorage.getItem('cpf_current_role') || 'all';
        
        const stages = [
            { id: 'all', label: 'All', icon: 'üìã' },
            { id: 'intake', label: 'Intake', icon: 'üìù' },
            { id: 'hea', label: 'HEA', icon: 'üè†' },
            { id: 'scoping', label: 'Scoping', icon: 'üìê' },
            { id: 'bidding', label: 'Bidding', icon: 'üí∞' },
            { id: 'approved', label: 'Approved', icon: '‚úÖ' },
            { id: 'implementation', label: 'Implementation', icon: 'üî®' },
            { id: 'completed', label: 'Completed', icon: 'üéâ' }
        ];
        
        // Initialize
        function init() {
            if (projects.length === 0) {
                createSampleProjects();
            }
            
            // Set role selector
            document.getElementById('roleSelector').value = currentRole;
            
            updateButtonVisibility();
            renderWorkflowNav();
            renderProjects();
            updatePortfolioDashboard();
            updateRoleDashboard();
        }
        
        function createSampleProjects() {
            const samples = [
                {
                    id: 'CPF-001',
                    type: 'weatherization',
                    scenario: 'low-income-homeowner',
                    address: '123 Main St, Portland OR',
                    status: 'scoping',
                    qualified: 'yes',
                    form300: true,
                    form320: false,
                    measures: [],
                    bids: [],
                    fundingSources: [],
                    approvals: [],
                    decisionPoints: [],
                    financials: {
                        recommended: 0,
                        selected: 0,
                        estimated: 0,
                        incentivized: 0,
                        net: 0,
                        actual: 0
                    },
                    createdDate: new Date().toISOString()
                },
                {
                    id: 'CPF-002',
                    type: 'heat-pump',
                    scenario: 'moderate-income-homeowner',
                    address: '456 Oak Ave, Portland OR',
                    status: 'bidding',
                    qualified: 'yes',
                    form300: true,
                    form320: false,
                    measures: [
                        { name: 'Heat Pump Installation', cost: 8000, incentive: 2000, selected: true }
                    ],
                    bids: [],
                    fundingSources: [],
                    approvals: [],
                    decisionPoints: [],
                    financials: {
                        recommended: 8000,
                        selected: 8000,
                        estimated: 0,
                        incentivized: 2000,
                        net: 6000,
                        actual: 0
                    },
                    createdDate: new Date().toISOString()
                }
            ];
            projects = samples;
            saveProjects();
        }
        
        function renderWorkflowNav() {
            const container = document.getElementById('workflowStages');
            
            // Apply role filter to counts
            let visibleProjects = projects;
            if (currentRole !== 'all') {
                visibleProjects = applyRoleFilter(projects, currentRole);
            }
            
            container.innerHTML = stages.map(stage => {
                const count = stage.id === 'all' ? visibleProjects.length : visibleProjects.filter(p => p.status === stage.id).length;
                return `
                    <div class="stage-chip ${currentStageFilter === stage.id ? 'active' : ''}" 
                         onclick="filterByStage('${stage.id}')">
                        ${stage.icon} ${stage.label}
                        <span class="stage-count">${count}</span>
                    </div>
                `;
            }).join('');
        }
        
        function filterByStage(stageId) {
            currentStageFilter = stageId;
            renderWorkflowNav();
            renderProjects();
            updatePortfolioDashboard();
        }
        
        function renderProjects() {
            let filtered = currentStageFilter === 'all' 
                ? projects 
                : projects.filter(p => p.status === currentStageFilter);
            
            // Apply role-based filtering
            if (currentRole !== 'all') {
                filtered = applyRoleFilter(filtered, currentRole);
            }
            
            const grid = document.getElementById('projectGrid');
            
            if (filtered.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: #666;">No projects in this stage</div>';
                return;
            }
            
            grid.innerHTML = filtered.map(project => `
                <div class="project-card ${selectedProjects.has(project.id) ? 'selected' : ''}" data-id="${project.id}">
                    <input type="checkbox" class="card-checkbox" 
                           ${selectedProjects.has(project.id) ? 'checked' : ''}
                           onchange="toggleProjectSelection('${project.id}')">
                    
                    <div class="card-content">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.75rem;">
                            <div>
                                <div style="font-size: 0.75rem; color: #666; font-weight: 600;">${project.id}</div>
                                <h3 style="margin: 0.25rem 0 0 0; font-size: 1rem;">${formatScenario(project.scenario)}</h3>
                            </div>
                            <span class="status-badge status-${project.status}">${formatStatus(project.status)}</span>
                        </div>
                        
                        <div class="info-row">
                            <span style="color: #666; font-size: 0.8rem;">üìç Address</span>
                            <span style="font-size: 0.8rem;">${project.address}</span>
                        </div>
                        <div class="info-row">
                            <span style="color: #666; font-size: 0.8rem;">üîß Type</span>
                            <span style="font-size: 0.8rem;">${formatType(project.type)}</span>
                        </div>
                        
                        <div class="card-financials">
                            <div class="mini-financial recommended">
                                <div class="mini-financial-label">Recommended</div>
                                <div class="mini-financial-amount">$${project.financials.recommended.toLocaleString()}</div>
                            </div>
                            <div class="mini-financial selected">
                                <div class="mini-financial-label">Selected</div>
                                <div class="mini-financial-amount">$${project.financials.selected.toLocaleString()}</div>
                            </div>
                            <div class="mini-financial estimated">
                                <div class="mini-financial-label">Estimated</div>
                                <div class="mini-financial-amount">$${project.financials.estimated.toLocaleString()}</div>
                            </div>
                            <div class="mini-financial incentivized">
                                <div class="mini-financial-label">Incentives ${project.status !== 'completed' && project.status !== 'implementation' ? '‚è≥' : ''}</div>
                                <div class="mini-financial-amount">$${project.financials.incentivized.toLocaleString()}</div>
                            </div>
                            <div class="mini-financial net" style="grid-column: 1 / -1;">
                                <div class="mini-financial-label">Net Cost ${project.status !== 'completed' && project.status !== 'implementation' ? '(Expected)' : ''}</div>
                                <div class="mini-financial-amount" style="font-size: 1.25rem;">$${project.financials.net.toLocaleString()}</div>
                            </div>
                        </div>
                        
                        <div class="card-quick-actions">
                            ${getQuickActions(project)}
                        </div>
                    </div>
                </div>
            `).join('');
            
            updateBulkButtons();
        }
        
        function getQuickActions(project) {
            // Check role permissions for actions
            const canView = canAccessProject(project, currentRole);
            const canEdit = canEditProject(project, currentRole);
            
            if (!canView) {
                return '<div style="text-align: center; color: #999; font-size: 0.8rem; padding: 1rem;">üîí No access</div>';
            }
            
            const actions = {
                'intake': [
                    { label: '‚úÖ Complete Intake', status: 'hea', description: 'Customer qualified, move to HEA' }
                ],
                'hea': [
                    { label: '‚Üê Back to Intake', status: 'intake', back: true },
                    { label: '‚úÖ Complete HEA', status: 'scoping', description: 'Assessment done, start scoping' }
                ],
                'scoping': [
                    { label: '‚Üê Back to HEA', status: 'hea', back: true },
                    { label: 'üìã Manage Measures', action: 'openScoping', primary: true },
                    { label: 'üìã 300CPF Form', action: 'openFormApprovals' },
                    { label: 'üéØ Decisions', action: 'openDecisions' },
                    { label: '‚úÖ Approvals', action: 'openApprovals' },
                    { label: '‚úÖ Complete Scoping', status: 'bidding', description: 'Measures finalized, request bids' }
                ],
                'bidding': [
                    { label: '‚Üê Back to Scoping', status: 'scoping', back: true },
                    { label: 'üí∞ Manage Bids', action: 'openBidding', primary: true },
                    { label: '‚úÖ Approvals', action: 'openApprovals' },
                    { label: '‚úÖ Approve Project', status: 'approved', description: 'Bid selected, approve for work' }
                ],
                'approved': [
                    { label: '‚Üê Back to Bidding', status: 'bidding', back: true },
                    { label: 'üî® Start Implementation', status: 'implementation', description: 'Begin work on project' }
                ],
                'implementation': [
                    { label: '‚Üê Back to Approved', status: 'approved', back: true },
                    { label: 'üíµ Record Actuals', action: 'openImplementation', primary: true },
                    { label: 'üíµ 320CPF Form', action: 'openFormApprovals' },
                    { label: '‚úÖ Approvals', action: 'openApprovals' },
                    { label: '‚úÖ Mark Complete', status: 'completed', description: 'Work finished, close project' }
                ],
                'completed': [
                    { label: '‚Üê Reopen Project', status: 'implementation', back: true, description: 'Move back to implementation' }
                ]
            };
            
            let stageActions = actions[project.status] || [];
            
            // Filter actions by role permissions
            if (currentRole !== 'all') {
                stageActions = filterActionsByRole(stageActions, project, currentRole);
            }
            
            if (!canEdit && stageActions.length > 0) {
                // Show view-only message if can view but not edit
                return '<div style="text-align: center; color: #666; font-size: 0.8rem; padding: 0.5rem;">üëÅÔ∏è View Only</div>';
            }
            
            return stageActions.map(action => {
                if (action.action) {
                    return `<button class="quick-btn ${action.primary ? 'primary' : ''}" onclick="${action.action}('${project.id}')" title="${action.description || ''}">${action.label}</button>`;
                } else {
                    const btnClass = action.back ? 'quick-btn' : 'quick-btn';
                    const style = action.back ? 'style="background: #fee2e2; border-color: #fca5a5; color: #991b1b;"' : '';
                    return `<button class="${btnClass}" ${style} onclick="quickStatusChange('${project.id}', '${action.status}')" title="${action.description || ''}">${action.label}</button>`;
                }
            }).join('');
        }
        
        function quickStatusChange(projectId, newStatus) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;
            
            const oldStatus = project.status;
            project.status = newStatus;
            
            ledger.record({
                action: 'STATUS_CHANGE',
                projectId,
                userId: currentUser.id,
                details: { from: oldStatus, to: newStatus }
            });
            
            qaGates.create({
                projectId,
                stage: newStatus,
                inspector: currentUser.id
            });
            
            saveProjects();
            renderWorkflowNav();
            renderProjects();
            updatePortfolioDashboard();
        }
        
        function openScoping(projectId) {
            currentEditingProject = projects.find(p => p.id === projectId);
            if (!currentEditingProject) return;
            
            if (!currentEditingProject.fundingSources) currentEditingProject.fundingSources = [];
            
            populateMeasureLibraryDropdown();
            populateScopingFundingDropdown();
            renderMeasureList();
            renderScopingFundingList();
            document.getElementById('scopingModal').classList.add('active');
        }
        
        function populateMeasureLibraryDropdown() {
            const dropdown = document.getElementById('measureLibrary');
            dropdown.innerHTML = '<option value="">Select from measure library...</option>';
            
            const categories = [...new Set(measureLibrary.map(m => m.category))];
            categories.forEach(category => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = category;
                measureLibrary.filter(m => m.category === category).forEach(measure => {
                    const option = document.createElement('option');
                    option.value = JSON.stringify(measure);
                    option.textContent = `${measure.name} ($${measure.typicalCost.toLocaleString()} / $${measure.typicalIncentive.toLocaleString()} incentive)`;
                    optgroup.appendChild(option);
                });
                dropdown.appendChild(optgroup);
            });
        }
        
        function addMeasureFromLibrary() {
            const dropdown = document.getElementById('measureLibrary');
            if (!dropdown.value) return;
            
            const measure = JSON.parse(dropdown.value);
            currentEditingProject.measures.push({
                name: measure.name,
                cost: measure.typicalCost,
                incentive: measure.typicalIncentive,
                selected: false
            });
            
            dropdown.value = '';
            renderMeasureList();
        }
        
        function importMeasures() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = e => {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = event => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if (Array.isArray(imported)) {
                            imported.forEach(m => {
                                if (m.name && (m.cost || m.typicalCost)) {
                                    currentEditingProject.measures.push({
                                        name: m.name,
                                        cost: m.cost || m.typicalCost || 0,
                                        incentive: m.incentive || m.typicalIncentive || 0,
                                        selected: m.selected || false
                                    });
                                }
                            });
                            renderMeasureList();
                            alert(`Imported ${imported.length} measures successfully!`);
                        }
                    } catch (err) {
                        alert('Error importing JSON: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        function exportMeasureLibrary() {
            const data = JSON.stringify(measureLibrary, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'measure-library.json';
            a.click();
        }
        
        function renderMeasureList() {
            const container = document.getElementById('measureList');
            if (!currentEditingProject.measures) currentEditingProject.measures = [];
            
            if (currentEditingProject.measures.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No measures added yet</p>';
            } else {
                container.innerHTML = currentEditingProject.measures.map((m, idx) => `
                    <div class="measure-item">
                        <div>
                            <div class="measure-name">${m.name}</div>
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; font-size: 0.8rem;">
                                <input type="checkbox" ${m.selected ? 'checked' : ''} onchange="toggleMeasureSelection(${idx})">
                                Selected for project
                            </label>
                        </div>
                        <div>
                            <div style="font-size: 0.7rem; color: #666; margin-bottom: 0.25rem;">Cost</div>
                            <input type="number" value="${m.cost}" step="0.01" 
                                   style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; text-align: right;"
                                   onchange="updateMeasureCost(${idx}, this.value)">
                        </div>
                        <div>
                            <div style="font-size: 0.7rem; color: #666; margin-bottom: 0.25rem;">Incentive</div>
                            <input type="number" value="${m.incentive}" step="0.01"
                                   style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; text-align: right;"
                                   onchange="updateMeasureIncentive(${idx}, this.value)">
                        </div>
                        <button class="remove-btn" onclick="removeMeasure(${idx})">‚úï</button>
                    </div>
                `).join('');
            }
            
            updateModalCostSummary();
        }
        
        function addMeasure() {
            const name = prompt('Measure name:', 'New Measure');
            if (!name) return;
            
            currentEditingProject.measures.push({
                name,
                cost: 0,
                incentive: 0,
                selected: false
            });
            
            renderMeasureList();
        }
        
        function removeMeasure(idx) {
            currentEditingProject.measures.splice(idx, 1);
            renderMeasureList();
        }
        
        function toggleMeasureSelection(idx) {
            currentEditingProject.measures[idx].selected = !currentEditingProject.measures[idx].selected;
            updateModalCostSummary();
        }
        
        function updateMeasureCost(idx, value) {
            currentEditingProject.measures[idx].cost = parseFloat(value) || 0;
            updateModalCostSummary();
        }
        
        function updateMeasureIncentive(idx, value) {
            currentEditingProject.measures[idx].incentive = parseFloat(value) || 0;
            updateModalCostSummary();
        }
        
        function updateModalCostSummary() {
            const recommended = currentEditingProject.measures.reduce((sum, m) => sum + m.cost, 0);
            const selected = currentEditingProject.measures.filter(m => m.selected).reduce((sum, m) => sum + m.cost, 0);
            const fundingIncentives = (currentEditingProject.fundingSources || []).reduce((sum, f) => sum + (f.amount || 0), 0);
            const incentives = fundingIncentives || currentEditingProject.measures.filter(m => m.selected).reduce((sum, m) => sum + m.incentive, 0);
            const net = selected - incentives;
            
            document.getElementById('modal-recommended').textContent = `$${recommended.toLocaleString()}`;
            document.getElementById('modal-selected').textContent = `$${selected.toLocaleString()}`;
            document.getElementById('modal-incentives').textContent = `$${incentives.toLocaleString()}`;
            document.getElementById('modal-net').textContent = `$${net.toLocaleString()}`;
        }
        
        function saveMeasures() {
            const recommended = currentEditingProject.measures.reduce((sum, m) => sum + m.cost, 0);
            const selected = currentEditingProject.measures.filter(m => m.selected).reduce((sum, m) => sum + m.cost, 0);
            
            // Calculate total incentives from funding sources if they exist
            const fundingIncentives = (currentEditingProject.fundingSources || []).reduce((sum, f) => sum + (f.amount || 0), 0);
            const incentives = fundingIncentives || currentEditingProject.measures.filter(m => m.selected).reduce((sum, m) => sum + m.incentive, 0);
            
            currentEditingProject.financials.recommended = recommended;
            currentEditingProject.financials.selected = selected;
            currentEditingProject.financials.incentivized = incentives;
            currentEditingProject.financials.net = selected - incentives;
            
            ledger.record({
                action: 'MEASURES_UPDATED',
                projectId: currentEditingProject.id,
                userId: currentUser.id,
                details: { measureCount: currentEditingProject.measures.length, recommended, selected }
            });
            
            saveProjects();
            closeModal('scopingModal');
            renderProjects();
            updatePortfolioDashboard();
        }
        
        function openFunding(projectId) {
            currentEditingProject = projects.find(p => p.id === projectId);
            if (!currentEditingProject) return;
            
            if (!currentEditingProject.fundingSources) currentEditingProject.fundingSources = [];
            
            populateFundingSourceDropdown();
            renderFundingSourceList();
            document.getElementById('fundingModal').classList.add('active');
        }
        
        function populateFundingSourceDropdown() {
            const dropdown = document.getElementById('fundingSourceLibrary');
            dropdown.innerHTML = '<option value="">Select funding source...</option>';
            
            const categories = [...new Set(fundingSourcesLibrary.map(f => f.category))];
            categories.forEach(category => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = category;
                fundingSourcesLibrary.filter(f => f.category === category).forEach(source => {
                    const option = document.createElement('option');
                    option.value = JSON.stringify(source);
                    const maxText = source.maxAmount ? ` (max $${source.maxAmount.toLocaleString()})` : '';
                    option.textContent = `${source.name} - ${source.type}${maxText}`;
                    optgroup.appendChild(option);
                });
                dropdown.appendChild(optgroup);
            });
        }
        
        function addFundingSourceFromLibrary() {
            const dropdown = document.getElementById('fundingSourceLibrary');
            if (!dropdown.value) return;
            
            const source = JSON.parse(dropdown.value);
            currentEditingProject.fundingSources.push({
                name: source.name,
                category: source.category,
                type: source.type,
                amount: 0,
                maxAmount: source.maxAmount,
                description: source.description,
                status: 'pending'
            });
            
            dropdown.value = '';
            renderFundingSourceList();
        }
        
        function renderFundingSourceList() {
            const container = document.getElementById('fundingSourceList');
            
            if (currentEditingProject.fundingSources.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No funding sources added yet</p>';
            } else {
                container.innerHTML = currentEditingProject.fundingSources.map((f, idx) => `
                    <div class="measure-item" style="grid-template-columns: 2fr 1fr auto auto;">
                        <div>
                            <div class="measure-name">${f.name}</div>
                            <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">
                                <span style="background: #e0e7ff; padding: 0.125rem 0.5rem; border-radius: 4px; font-weight: 600;">${f.type}</span>
                                ${f.maxAmount ? '<span style="margin-left: 0.5rem;">Max: $' + f.maxAmount.toLocaleString() + '</span>' : ''}
                            </div>
                            <select style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.75rem; border: 1px solid var(--border); border-radius: 4px;" onchange="updateFundingStatus(${idx}, this.value)">
                                <option value="pending" ${f.status === 'pending' ? 'selected' : ''}>‚è≥ Pending</option>
                                <option value="applied" ${f.status === 'applied' ? 'selected' : ''}>üìù Applied</option>
                                <option value="approved" ${f.status === 'approved' ? 'selected' : ''}>‚úÖ Approved</option>
                                <option value="disbursed" ${f.status === 'disbursed' ? 'selected' : ''}>üíµ Disbursed</option>
                                <option value="denied" ${f.status === 'denied' ? 'selected' : ''}>‚ùå Denied</option>
                            </select>
                        </div>
                        <div>
                            <div style="font-size: 0.7rem; color: #666; margin-bottom: 0.25rem;">Amount</div>
                            <input type="number" value="${f.amount}" step="0.01" 
                                   placeholder="${f.maxAmount ? 'Max: $' + f.maxAmount.toLocaleString() : '0.00'}"
                                   style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; text-align: right;"
                                   onchange="updateFundingAmount(${idx}, this.value)"
                                   ${f.maxAmount ? 'max="' + f.maxAmount + '"' : ''}>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.7rem; color: #666;">Status</div>
                            <div style="margin-top: 0.25rem; font-size: 0.8rem; font-weight: 600;">
                                ${getStatusIcon(f.status)}
                            </div>
                        </div>
                        <button class="remove-btn" onclick="removeFundingSource(${idx})">‚úï</button>
                    </div>
                `).join('');
            }
            
            updateFundingModalSummary();
        }
        
        function getStatusIcon(status) {
            const icons = {
                'pending': '‚è≥',
                'applied': 'üìã',
                'approved': '‚úÖ',
                'disbursed': 'üíµ',
                'denied': '‚ùå'
            };
            return icons[status] || '‚è≥';
        }
        
        function updateFundingAmount(idx, value) {
            const amount = parseFloat(value) || 0;
            const maxAmount = currentEditingProject.fundingSources[idx].maxAmount;
            
            if (maxAmount && amount > maxAmount) {
                alert(`Amount exceeds maximum of $${maxAmount.toLocaleString()} for this funding source.`);
                currentEditingProject.fundingSources[idx].amount = maxAmount;
            } else {
                currentEditingProject.fundingSources[idx].amount = amount;
            }
            
            renderFundingSourceList();
        }
        
        function updateFundingStatus(idx, status) {
            currentEditingProject.fundingSources[idx].status = status;
            renderFundingSourceList();
        }
        
        function removeFundingSource(idx) {
            currentEditingProject.fundingSources.splice(idx, 1);
            renderFundingSourceList();
        }
        
        function updateFundingModalSummary() {
            const selectedMeasuresCost = currentEditingProject.measures.filter(m => m.selected).reduce((sum, m) => sum + m.cost, 0);
            const totalIncentives = currentEditingProject.fundingSources.reduce((sum, f) => sum + (f.amount || 0), 0);
            const netCost = selectedMeasuresCost - totalIncentives;
            
            document.getElementById('modal-funding-cost').textContent = `$${selectedMeasuresCost.toLocaleString()}`;
            document.getElementById('modal-funding-incentives').textContent = `$${totalIncentives.toLocaleString()}`;
            document.getElementById('modal-funding-net').textContent = `$${netCost.toLocaleString()}`;
        }
        
        function saveFundingSources() {
            const totalIncentives = currentEditingProject.fundingSources.reduce((sum, f) => sum + (f.amount || 0), 0);
            const selectedCost = currentEditingProject.financials.selected || currentEditingProject.measures.filter(m => m.selected).reduce((sum, m) => sum + m.cost, 0);
            
            currentEditingProject.financials.incentivized = totalIncentives;
            currentEditingProject.financials.net = selectedCost - totalIncentives;
            
            ledger.record({
                action: 'FUNDING_SOURCES_UPDATED',
                projectId: currentEditingProject.id,
                userId: currentUser.id,
                details: { 
                    sourceCount: currentEditingProject.fundingSources.length, 
                    totalIncentives,
                    sources: currentEditingProject.fundingSources.map(f => ({ name: f.name, amount: f.amount, status: f.status }))
                }
            });
            
            saveProjects();
            closeModal('fundingModal');
            renderProjects();
            updatePortfolioDashboard();
        }
        
        function openBidding(projectId) {
            currentEditingProject = projects.find(p => p.id === projectId);
            if (!currentEditingProject) return;
            
            renderBidList();
            document.getElementById('biddingModal').classList.add('active');
        }
        
        function renderBidList() {
            const container = document.getElementById('bidList');
            if (!currentEditingProject.bids) currentEditingProject.bids = [];
            
            if (currentEditingProject.bids.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 2rem;">No bids received yet</p>';
            } else {
                container.innerHTML = currentEditingProject.bids.map((b, idx) => `
                    <div class="bid-item" style="grid-template-columns: 2fr 1fr auto auto;">
                        <div>
                            <div style="font-weight: 600;">${b.contractor}</div>
                            <label style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; font-size: 0.8rem;">
                                <input type="radio" name="selectedBid" ${b.selected ? 'checked' : ''} onchange="selectBid(${idx})">
                                Selected bid
                            </label>
                        </div>
                        <div>
                            <div style="font-size: 0.7rem; color: #666; margin-bottom: 0.25rem;">Bid Amount</div>
                            <input type="number" value="${b.amount}" step="0.01"
                                   style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; text-align: right;"
                                   onchange="updateBidAmount(${idx}, this.value)">
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.7rem; color: #666;">Status</div>
                            <div style="font-size: 0.8rem; font-weight: 600; color: ${b.selected ? 'var(--success)' : '#666'};">
                                ${b.selected ? '‚úì Selected' : 'Pending'}
                            </div>
                        </div>
                        <button class="remove-btn" onclick="removeBid(${idx})">‚úï</button>
                    </div>
                `).join('');
            }
            
            updateBidModalSummary();
        }
        
        function addBid() {
            const contractor = prompt('Contractor name:', 'ABC Contractors');
            if (!contractor) return;
            
            currentEditingProject.bids.push({
                contractor,
                amount: 0,
                selected: false
            });
            
            renderBidList();
        }
        
        function removeBid(idx) {
            currentEditingProject.bids.splice(idx, 1);
            renderBidList();
        }
        
        function selectBid(idx) {
            currentEditingProject.bids.forEach((b, i) => b.selected = i === idx);
            renderBidList();
        }
        
        function updateBidAmount(idx, value) {
            currentEditingProject.bids[idx].amount = parseFloat(value) || 0;
            updateBidModalSummary();
        }
        
        function updateBidModalSummary() {
            const selectedBid = currentEditingProject.bids.find(b => b.selected);
            const bidAmount = selectedBid ? selectedBid.amount : 0;
            const incentives = currentEditingProject.financials.incentivized;
            const net = bidAmount - incentives;
            
            document.getElementById('modal-bid-selected').textContent = `$${bidAmount.toLocaleString()}`;
            document.getElementById('modal-bid-incentives').textContent = `$${incentives.toLocaleString()}`;
            document.getElementById('modal-bid-net').textContent = `$${net.toLocaleString()}`;
        }
        
        function saveBids() {
            const selectedBid = currentEditingProject.bids.find(b => b.selected);
            if (selectedBid) {
                currentEditingProject.financials.estimated = selectedBid.amount;
                currentEditingProject.financials.net = selectedBid.amount - currentEditingProject.financials.incentivized;
            }
            
            ledger.record({
                action: 'BIDS_UPDATED',
                projectId: currentEditingProject.id,
                userId: currentUser.id,
                details: { bidCount: currentEditingProject.bids.length, selectedAmount: selectedBid?.amount || 0 }
            });
            
            saveProjects();
            closeModal('biddingModal');
            renderProjects();
            updatePortfolioDashboard();
        }
        
        function openImplementation(projectId) {
            currentEditingProject = projects.find(p => p.id === projectId);
            if (!currentEditingProject) return;
            
            document.getElementById('actualCost').value = currentEditingProject.financials.actual || 0;
            document.getElementById('actualIncentives').value = currentEditingProject.financials.incentivized || 0;
            
            renderImplementationFunding();
            updateActualCostsSummary();
            document.getElementById('implementationModal').classList.add('active');
        }
        
        function updateActualCostsSummary() {
            const actual = parseFloat(document.getElementById('actualCost').value) || 0;
            const incentives = parseFloat(document.getElementById('actualIncentives').value) || 0;
            const net = actual - incentives;
            
            document.getElementById('modal-actual').textContent = `$${actual.toLocaleString()}`;
            document.getElementById('modal-actual-incentives').textContent = `$${incentives.toLocaleString()}`;
            document.getElementById('modal-actual-net').textContent = `$${net.toLocaleString()}`;
        }
        
        document.getElementById('actualCost')?.addEventListener('input', updateActualCostsSummary);
        document.getElementById('actualIncentives')?.addEventListener('input', updateActualCostsSummary);
        
        function saveActualCosts() {
            const actual = parseFloat(document.getElementById('actualCost').value) || 0;
            const incentives = parseFloat(document.getElementById('actualIncentives').value) || 0;
            
            currentEditingProject.financials.actual = actual;
            currentEditingProject.financials.incentivized = incentives;
            currentEditingProject.financials.net = actual - incentives;
            
            ledger.record({
                action: 'ACTUAL_COSTS_RECORDED',
                projectId: currentEditingProject.id,
                userId: currentUser.id,
                details: { actual, incentives }
            });
            
            saveProjects();
            closeModal('implementationModal');
            renderProjects();
            updatePortfolioDashboard();
        }
        
        function updatePortfolioDashboard() {
            const filtered = currentStageFilter === 'all' 
                ? projects 
                : projects.filter(p => p.status === currentStageFilter);
            
            const totals = filtered.reduce((acc, p) => {
                acc.recommended += p.financials.recommended;
                acc.selected += p.financials.selected;
                acc.estimated += p.financials.estimated;
                acc.incentivized += p.financials.incentivized;
                acc.net += p.financials.net;
                acc.recommendedCount += (p.measures?.length || 0);
                acc.selectedCount += (p.measures?.filter(m => m.selected).length || 0);
                return acc;
            }, { recommended: 0, selected: 0, estimated: 0, incentivized: 0, net: 0, recommendedCount: 0, selectedCount: 0 });
            
            document.getElementById('portfolioScope').textContent = currentStageFilter === 'all' ? 'All Projects' : `${formatStatus(currentStageFilter)} Stage`;
            document.getElementById('portfolioCount').textContent = filtered.length;
            document.getElementById('portfolio-recommended').textContent = `$${totals.recommended.toLocaleString()}`;
            document.getElementById('portfolio-selected').textContent = `$${totals.selected.toLocaleString()}`;
            document.getElementById('portfolio-estimated').textContent = `$${totals.estimated.toLocaleString()}`;
            document.getElementById('portfolio-incentivized').textContent = `$${totals.incentivized.toLocaleString()}`;
            document.getElementById('portfolio-net').textContent = `$${totals.net.toLocaleString()}`;
            document.getElementById('portfolio-recommended-count').textContent = totals.recommendedCount;
            document.getElementById('portfolio-selected-count').textContent = totals.selectedCount;
        }
        
        function toggleProjectSelection(projectId) {
            if (selectedProjects.has(projectId)) {
                selectedProjects.delete(projectId);
            } else {
                selectedProjects.add(projectId);
            }
            renderProjects();
        }
        
        function toggleSelectAll() {
            const filtered = currentStageFilter === 'all' 
                ? projects 
                : projects.filter(p => p.status === currentStageFilter);
            
            if (selectedProjects.size === filtered.length) {
                selectedProjects.clear();
            } else {
                filtered.forEach(p => selectedProjects.add(p.id));
            }
            renderProjects();
        }
        
        function updateBulkButtons() {
            const count = selectedProjects.size;
            document.getElementById('selectedCount').textContent = count;
            document.getElementById('bulkApproveBtn').disabled = count === 0;
            document.getElementById('bulkExportBtn').disabled = count === 0;
        }
        
        function bulkApprove() {
            selectedProjects.forEach(projectId => {
                quickStatusChange(projectId, 'approved');
            });
            selectedProjects.clear();
        }
        
        function bulkExport() {
            const selected = projects.filter(p => selectedProjects.has(p.id));
            exportProjectsCSV(selected, 'selected-projects');
        }
        
        function exportPortfolio() {
            const filtered = currentStageFilter === 'all' 
                ? projects 
                : projects.filter(p => p.status === currentStageFilter);
            exportProjectsCSV(filtered, `portfolio-${currentStageFilter}`);
        }
        
        function exportProjectsCSV(projectList, filename) {
            const headers = ['ID', 'Type', 'Status', 'Address', 'Recommended', 'Selected', 'Estimated', 'Incentivized', 'Net Cost', 'Measures', 'Bids'];
            const rows = projectList.map(p => [
                p.id,
                p.type,
                p.status,
                p.address,
                p.financials.recommended,
                p.financials.selected,
                p.financials.estimated,
                p.financials.incentivized,
                p.financials.net,
                p.measures?.length || 0,
                p.bids?.length || 0
            ]);
            
            const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${filename}-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        
        function openNewProjectModal() {
            document.getElementById('projectModal').classList.add('active');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        document.getElementById('projectForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const newProject = {
                id: 'CPF-' + String(projects.length + 1).padStart(3, '0'),
                type: document.getElementById('projectType').value,
                scenario: document.getElementById('customerScenario').value,
                address: document.getElementById('address').value,
                status: 'intake',
                qualified: document.getElementById('qualified').value,
                form300: false,
                form320: false,
                measures: [],
                bids: [],
                fundingSources: [],
                approvals: [],
                decisionPoints: [],
                financials: {
                    recommended: 0,
                    selected: 0,
                    estimated: 0,
                    incentivized: 0,
                    net: 0,
                    actual: 0
                },
                createdDate: new Date().toISOString()
            };
            
            projects.push(newProject);
            
            ledger.record({
                action: 'PROJECT_CREATED',
                projectId: newProject.id,
                userId: currentUser.id,
                details: { type: newProject.type, scenario: newProject.scenario }
            });
            
            saveProjects();
            renderWorkflowNav();
            renderProjects();
            updatePortfolioDashboard();
            closeModal('projectModal');
        });
        
        function saveProjects() {
            localStorage.setItem('cpf_projects_financial', JSON.stringify(projects));
        }
        
        function formatType(type) {
            return type.split('-').map(w => w[0].toUpperCase() + w.slice(1)).join(' ');
        }
        
        function formatScenario(scenario) {
            return scenario.split('-').map(w => w[0].toUpperCase() + w.slice(1)).join(' ');
        }
        
        function formatStatus(status) {
            return status.split('-').map(w => w[0].toUpperCase() + w.slice(1)).join(' ');
        }
        
        function openLedger() {
            const projectFilter = document.getElementById('ledgerFilterProject');
            projectFilter.innerHTML = '<option value="">All Projects</option>';
            projects.forEach(p => {
                const option = document.createElement('option');
                option.value = p.id;
                option.textContent = `${p.id} - ${formatScenario(p.scenario)}`;
                projectFilter.appendChild(option);
            });
            
            renderLedger();
            document.getElementById('ledgerModal').classList.add('active');
        }
        
        function renderLedger() {
            const projectFilter = document.getElementById('ledgerFilterProject').value;
            const actionFilter = document.getElementById('ledgerFilterAction').value;
            
            let entries = ledger.getAll();
            
            if (projectFilter) {
                entries = entries.filter(e => e.projectId === projectFilter);
            }
            
            if (actionFilter) {
                entries = entries.filter(e => e.action === actionFilter);
            }
            
            entries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            const container = document.getElementById('ledgerEntries');
            
            if (entries.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666;">No ledger entries found</div>';
                return;
            }
            
            container.innerHTML = entries.map(entry => `
                <div class="ledger-entry ${entry.action}">
                    <div class="ledger-header">
                        <div>
                            <strong>${entry.action.replace(/_/g, ' ')}</strong>
                            <span style="margin-left: 1rem; color: #666;">${entry.projectId || 'System'}</span>
                        </div>
                        <div class="ledger-timestamp">${new Date(entry.timestamp).toLocaleString()}</div>
                    </div>
                    <div style="color: #666; font-size: 0.8rem;">User: ${entry.userId}</div>
                    ${entry.details ? `
                        <div class="ledger-details">
                            <strong>Details:</strong>
                            <pre style="margin: 0.5rem 0 0 0; white-space: pre-wrap; font-size: 0.75rem;">${JSON.stringify(entry.details, null, 2)}</pre>
                        </div>
                    ` : ''}
                    <div class="ledger-hash">Hash: ${entry.hash || 'N/A'}</div>
                </div>
            `).join('');
        }
        
        function exportLedger() {
            const projectFilter = document.getElementById('ledgerFilterProject').value;
            const actionFilter = document.getElementById('ledgerFilterAction').value;
            
            let entries = ledger.getAll();
            
            if (projectFilter) {
                entries = entries.filter(e => e.projectId === projectFilter);
            }
            
            if (actionFilter) {
                entries = entries.filter(e => e.action === actionFilter);
            }
            
            const data = JSON.stringify(entries, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ledger-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }
        
        // Funding in Scoping Functions
        function populateScopingFundingDropdown() {
            const dropdown = document.getElementById('scopingFundingLibrary');
            dropdown.innerHTML = '<option value="">Select funding source...</option>';
            
            const categories = [...new Set(fundingSourcesLibrary.map(f => f.category))];
            categories.forEach(category => {
                const optgroup = document.createElement('optgroup');
                optgroup.label = category;
                fundingSourcesLibrary.filter(f => f.category === category).forEach(source => {
                    const option = document.createElement('option');
                    option.value = JSON.stringify(source);
                    const maxText = source.maxAmount ? ` (max $${source.maxAmount.toLocaleString()})` : '';
                    option.textContent = `${source.name} - ${source.type}${maxText}`;
                    optgroup.appendChild(option);
                });
                dropdown.appendChild(optgroup);
            });
        }
        
        function addFundingToScoping() {
            const dropdown = document.getElementById('scopingFundingLibrary');
            if (!dropdown.value) return;
            
            const source = JSON.parse(dropdown.value);
            currentEditingProject.fundingSources.push({
                name: source.name,
                category: source.category,
                type: source.type,
                amount: 0,
                maxAmount: source.maxAmount,
                description: source.description,
                status: 'pending'
            });
            
            dropdown.value = '';
            renderScopingFundingList();
            updateModalCostSummary();
        }
        
        function renderScopingFundingList() {
            const container = document.getElementById('scopingFundingList');
            
            if (!currentEditingProject.fundingSources || currentEditingProject.fundingSources.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 1rem; font-size: 0.875rem;">No funding sources added yet</p>';
            } else {
                container.innerHTML = currentEditingProject.fundingSources.map((f, idx) => `
                    <div class="measure-item" style="grid-template-columns: 2fr 1fr auto auto; padding: 0.75rem; margin-bottom: 0.5rem;">
                        <div>
                            <div class="measure-name" style="font-size: 0.9rem;">${f.name}</div>
                            <div style="font-size: 0.7rem; color: #666; margin-top: 0.25rem;">
                                <span style="background: #e0e7ff; padding: 0.125rem 0.5rem; border-radius: 4px; font-weight: 600;">${f.type}</span>
                                ${f.maxAmount ? '<span style="margin-left: 0.5rem;">Max: $' + f.maxAmount.toLocaleString() + '</span>' : ''}
                            </div>
                            <select style="margin-top: 0.5rem; padding: 0.25rem 0.5rem; font-size: 0.7rem; border: 1px solid var(--border); border-radius: 4px;" onchange="updateScopingFundingStatus(${idx}, this.value)">
                                <option value="pending" ${f.status === 'pending' ? 'selected' : ''}>‚è≥ Pending</option>
                                <option value="applied" ${f.status === 'applied' ? 'selected' : ''}>üìù Applied</option>
                                <option value="approved" ${f.status === 'approved' ? 'selected' : ''}>‚úÖ Approved</option>
                                <option value="disbursed" ${f.status === 'disbursed' ? 'selected' : ''}>üíµ Disbursed</option>
                                <option value="denied" ${f.status === 'denied' ? 'selected' : ''}>‚ùå Denied</option>
                            </select>
                        </div>
                        <div>
                            <div style="font-size: 0.7rem; color: #666; margin-bottom: 0.25rem;">Amount</div>
                            <input type="number" value="${f.amount}" step="0.01" 
                                   placeholder="${f.maxAmount ? 'Max: $' + f.maxAmount.toLocaleString() : '0.00'}"
                                   style="width: 100%; padding: 0.5rem; border: 1px solid var(--border); border-radius: 4px; text-align: right; font-size: 0.875rem;"
                                   onchange="updateScopingFundingAmount(${idx}, this.value)"
                                   ${f.maxAmount ? 'max="' + f.maxAmount + '"' : ''}>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 0.7rem; color: #666;">Status</div>
                            <div style="margin-top: 0.25rem; font-size: 0.9rem; font-weight: 600;">
                                ${getStatusIcon(f.status)}
                            </div>
                        </div>
                        <button class="remove-btn" onclick="removeScopingFunding(${idx})">‚úï</button>
                    </div>
                `).join('');
            }
        }
        
        function updateScopingFundingAmount(idx, value) {
            const amount = parseFloat(value) || 0;
            const maxAmount = currentEditingProject.fundingSources[idx].maxAmount;
            
            if (maxAmount && amount > maxAmount) {
                alert(`Amount exceeds maximum of $${maxAmount.toLocaleString()} for this funding source.`);
                currentEditingProject.fundingSources[idx].amount = maxAmount;
            } else {
                currentEditingProject.fundingSources[idx].amount = amount;
            }
            
            renderScopingFundingList();
            updateModalCostSummary();
        }
        
        function updateScopingFundingStatus(idx, status) {
            currentEditingProject.fundingSources[idx].status = status;
            renderScopingFundingList();
        }
        
        function removeScopingFunding(idx) {
            currentEditingProject.fundingSources.splice(idx, 1);
            renderScopingFundingList();
            updateModalCostSummary();
        }
        
        // Implementation Funding Update
        function renderImplementationFunding() {
            const container = document.getElementById('implementationFundingList');
            if (!currentEditingProject.fundingSources || currentEditingProject.fundingSources.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 0.75rem; font-size: 0.8rem;">No funding sources configured</p>';
                return;
            }
            
            container.innerHTML = currentEditingProject.fundingSources.map((f, idx) => `
                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 0.5rem; align-items: center; padding: 0.5rem; background: white; border: 1px solid var(--border); border-radius: 4px; margin-bottom: 0.5rem;">
                    <div>
                        <div style="font-weight: 600; font-size: 0.8rem;">${f.name}</div>
                        <div style="font-size: 0.7rem; color: #666;">${f.type} ‚Ä¢ ${getStatusIcon(f.status)} ${f.status}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.7rem; color: #666; margin-bottom: 0.25rem;">Expected</div>
                        <div style="font-weight: 600; font-size: 0.8rem;">$${(f.amount || 0).toLocaleString()}</div>
                    </div>
                    <div>
                        <div style="font-size: 0.7rem; color: #666; margin-bottom: 0.25rem;">Actual</div>
                        <input type="number" value="${f.actualAmount || f.amount || 0}" step="0.01" 
                               style="width: 100%; padding: 0.4rem; border: 1px solid var(--border); border-radius: 4px; text-align: right; font-size: 0.8rem;"
                               onchange="updateImplementationFundingActual(${idx}, this.value)">
                    </div>
                </div>
            `).join('');
        }
        
        function updateImplementationFundingActual(idx, value) {
            currentEditingProject.fundingSources[idx].actualAmount = parseFloat(value) || 0;
            updateActualCostsSummary();
        }
        
        // Multi-Party Approval Functions
        function openApprovals(projectId) {
            currentEditingProject = projects.find(p => p.id === projectId);
            if (!currentEditingProject) return;
            
            if (!currentEditingProject.approvals) currentEditingProject.approvals = [];
            
            const infoDiv = document.getElementById('approvalProjectInfo');
            infoDiv.innerHTML = `
                <div><strong>Project:</strong> ${currentEditingProject.id} - ${formatScenario(currentEditingProject.scenario)}</div>
                <div style="margin-top: 0.25rem;"><strong>Status:</strong> ${formatStatus(currentEditingProject.status)}</div>
                <div style="margin-top: 0.25rem;"><strong>Address:</strong> ${currentEditingProject.address}</div>
                <div style="margin-top: 0.25rem;"><strong>Net Cost:</strong> $${(currentEditingProject.financials.net || 0).toLocaleString()}</div>
            `;
            
            renderApprovalsList();
            document.getElementById('approvalModal').classList.add('active');
        }
        
        function renderApprovalsList() {
            const container = document.getElementById('approvalsList');
            
            if (currentEditingProject.approvals.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 1.5rem; font-size: 0.875rem;">No approvals recorded yet</p>';
            } else {
                container.innerHTML = currentEditingProject.approvals.map((a, idx) => `
                    <div style="background: ${a.approved ? '#d1fae5' : '#f8fafc'}; border: 1px solid ${a.approved ? 'var(--success)' : 'var(--border)'}; border-radius: 6px; padding: 0.75rem; margin-bottom: 0.5rem; display: grid; grid-template-columns: 1fr auto auto; gap: 0.75rem; align-items: center;">
                        <div>
                            <div style="font-weight: 600; font-size: 0.875rem;">${a.party}</div>
                            <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">${a.stage}</div>
                            ${a.timestamp ? '<div style="font-size: 0.7rem; color: #999; margin-top: 0.25rem;">' + new Date(a.timestamp).toLocaleString() + '</div>' : ''}
                            ${a.notes ? '<div style="font-size: 0.75rem; color: #666; margin-top: 0.5rem; font-style: italic;">"' + a.notes + '"</div>' : ''}
                        </div>
                        <div>
                            ${a.approved 
                                ? '<span style="color: var(--success); font-weight: 600; font-size: 0.875rem;">‚úÖ Approved</span>' 
                                : '<button class="btn btn-success" style="padding: 0.5rem 0.75rem; font-size: 0.8rem;" onclick="approveItem(' + idx + ')">Approve</button>'}
                        </div>
                        <button class="remove-btn" style="font-size: 0.8rem;" onclick="removeApproval(${idx})">‚úï</button>
                    </div>
                `).join('');
            }
        }
        
        function addApproval() {
            const party = document.getElementById('approvalParty').value;
            const stage = document.getElementById('approvalStage').value;
            
            if (!party || !stage) {
                alert('Please select both party and stage');
                return;
            }
            
            currentEditingProject.approvals.push({
                party,
                stage,
                approved: false,
                timestamp: null,
                approvedBy: null,
                notes: ''
            });
            
            document.getElementById('approvalParty').value = '';
            document.getElementById('approvalStage').value = '';
            
            renderApprovalsList();
        }
        
        function approveItem(idx) {
            const notes = prompt('Optional notes for this approval:', '');
            
            currentEditingProject.approvals[idx].approved = true;
            currentEditingProject.approvals[idx].timestamp = new Date().toISOString();
            currentEditingProject.approvals[idx].approvedBy = currentUser.id;
            currentEditingProject.approvals[idx].notes = notes || '';
            
            ledger.record({
                action: 'APPROVAL_GRANTED',
                projectId: currentEditingProject.id,
                userId: currentUser.id,
                details: {
                    party: currentEditingProject.approvals[idx].party,
                    stage: currentEditingProject.approvals[idx].stage,
                    notes
                }
            });
            
            renderApprovalsList();
        }
        
        function removeApproval(idx) {
            currentEditingProject.approvals.splice(idx, 1);
            renderApprovalsList();
        }
        
        function saveApprovals() {
            const approvedCount = currentEditingProject.approvals.filter(a => a.approved).length;
            const totalCount = currentEditingProject.approvals.length;
            
            ledger.record({
                action: 'APPROVALS_UPDATED',
                projectId: currentEditingProject.id,
                userId: currentUser.id,
                details: { approvedCount, totalCount }
            });
            
            saveProjects();
            closeModal('approvalModal');
            renderProjects();
        }
        
        // CPF Form Approval Functions (300/320)
        function openFormApprovals(projectId) {
            currentEditingProject = projects.find(p => p.id === projectId);
            if (!currentEditingProject) return;
            
            if (!currentEditingProject.form300Approvals) {
                currentEditingProject.form300Approvals = [
                    { role: 'Program Coordinator', approved: false, timestamp: null, approvedBy: null },
                    { role: 'Finance Director', approved: false, timestamp: null, approvedBy: null }
                ];
            }
            
            if (!currentEditingProject.form320Approvals) {
                currentEditingProject.form320Approvals = [
                    { role: 'QA Inspector', approved: false, timestamp: null, approvedBy: null },
                    { role: 'Finance Director', approved: false, timestamp: null, approvedBy: null },
                    { role: 'Program Coordinator', approved: false, timestamp: null, approvedBy: null }
                ];
            }
            
            const infoDiv = document.getElementById('formApprovalProjectInfo');
            infoDiv.innerHTML = `
                <div><strong>Project:</strong> ${currentEditingProject.id} - ${formatScenario(currentEditingProject.scenario)}</div>
                <div style="margin-top: 0.25rem;"><strong>Status:</strong> ${formatStatus(currentEditingProject.status)}</div>
                <div style="margin-top: 0.25rem;"><strong>Net Cost:</strong> $${(currentEditingProject.financials.net || 0).toLocaleString()}</div>
            `;
            
            renderFormApprovalStatus();
            document.getElementById('formApprovalModal').classList.add('active');
        }
        
        function renderFormApprovalStatus() {
            // Form 300 Status
            const form300Approved = currentEditingProject.form300;
            const form300AllApproved = currentEditingProject.form300Approvals.every(a => a.approved);
            const form300StatusDiv = document.getElementById('form300Status');
            const form300ApproversDiv = document.getElementById('form300Approvers');
            
            if (form300Approved) {
                form300StatusDiv.innerHTML = '‚úÖ Approved';
                form300StatusDiv.style.background = '#d1fae5';
                form300StatusDiv.style.color = 'var(--success)';
                document.getElementById('form300ApproveBtn').disabled = true;
            } else if (form300AllApproved) {
                form300StatusDiv.innerHTML = '‚è≥ Pending Final';
                form300StatusDiv.style.background = '#fef3c7';
                form300StatusDiv.style.color = 'var(--warning)';
            } else {
                form300StatusDiv.innerHTML = '‚è≥ Pending';
                form300StatusDiv.style.background = '#f3f4f6';
                form300StatusDiv.style.color = '#666';
            }
            
            form300ApproversDiv.innerHTML = currentEditingProject.form300Approvals.map((a, idx) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: ${a.approved ? '#d1fae5' : '#f8fafc'}; border: 1px solid ${a.approved ? 'var(--success)' : 'var(--border)'}; border-radius: 4px; margin-bottom: 0.5rem; font-size: 0.85rem;">
                    <div>
                        <strong>${a.role}</strong>
                        ${a.timestamp ? '<div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">' + new Date(a.timestamp).toLocaleString() + ' by ' + a.approvedBy + '</div>' : ''}
                    </div>
                    <div>${a.approved ? '‚úÖ Approved' : '‚è≥ Pending'}</div>
                </div>
            `).join('');
            
            // Form 320 Status
            const form320Approved = currentEditingProject.form320;
            const form320AllApproved = currentEditingProject.form320Approvals.every(a => a.approved);
            const form320StatusDiv = document.getElementById('form320Status');
            const form320ApproversDiv = document.getElementById('form320Approvers');
            const form320Btn = document.getElementById('form320ApproveBtn');
            
            // 320 can only be approved after 300
            const canApprove320 = form300Approved && currentEditingProject.status === 'implementation';
            
            if (form320Approved) {
                form320StatusDiv.innerHTML = '‚úÖ Approved';
                form320StatusDiv.style.background = '#d1fae5';
                form320StatusDiv.style.color = 'var(--success)';
                form320Btn.disabled = true;
            } else if (!canApprove320) {
                form320StatusDiv.innerHTML = 'üîí Locked';
                form320StatusDiv.style.background = '#f3f4f6';
                form320StatusDiv.style.color = '#999';
                form320Btn.disabled = true;
            } else if (form320AllApproved) {
                form320StatusDiv.innerHTML = '‚è≥ Pending Final';
                form320StatusDiv.style.background = '#fef3c7';
                form320StatusDiv.style.color = 'var(--warning)';
                form320Btn.disabled = false;
            } else {
                form320StatusDiv.innerHTML = '‚è≥ Pending';
                form320StatusDiv.style.background = '#f8fafc';
                form320StatusDiv.style.color = '#666';
                form320Btn.disabled = false;
            }
            
            form320ApproversDiv.innerHTML = currentEditingProject.form320Approvals.map((a, idx) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem; background: ${a.approved ? '#d1fae5' : '#f8fafc'}; border: 1px solid ${a.approved ? 'var(--success)' : 'var(--border)'}; border-radius: 4px; margin-bottom: 0.5rem; font-size: 0.85rem;">
                    <div>
                        <strong>${a.role}</strong>
                        ${a.timestamp ? '<div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">' + new Date(a.timestamp).toLocaleString() + ' by ' + a.approvedBy + '</div>' : ''}
                    </div>
                    <div>${a.approved ? '‚úÖ Approved' : (canApprove320 ? '‚è≥ Pending' : 'üîí Locked')}</div>
                </div>
            `).join('');
        }
        
        function approveForm(formType) {
            const currentRole = prompt('Enter your role for this approval:', 'Program Coordinator');
            if (!currentRole) return;
            
            const approvals = formType === '300' ? currentEditingProject.form300Approvals : currentEditingProject.form320Approvals;
            const approver = approvals.find(a => a.role === currentRole && !a.approved);
            
            if (!approver) {
                alert('No pending approval found for this role, or already approved.');
                return;
            }
            
            approver.approved = true;
            approver.timestamp = new Date().toISOString();
            approver.approvedBy = currentUser.id;
            
            // Check if all approved
            const allApproved = approvals.every(a => a.approved);
            if (allApproved) {
                if (formType === '300') {
                    currentEditingProject.form300 = true;
                    alert('‚úÖ 300CPF Form fully approved! Project authorized.');
                } else {
                    currentEditingProject.form320 = true;
                    alert('‚úÖ 320CPF Form fully approved! Payment authorized.');
                }
            }
            
            ledger.record({
                action: 'FORM_APPROVED',
                projectId: currentEditingProject.id,
                userId: currentUser.id,
                details: { formType: formType + 'CPF', role: currentRole, fullyApproved: allApproved }
            });
            
            saveProjects();
            renderFormApprovalStatus();
            renderProjects();
        }
        
        function requestForm300Revision() {
            const reason = prompt('Reason for revision request:', '');
            if (!reason) return;
            
            currentEditingProject.form300Approvals.forEach(a => {
                a.approved = false;
                a.timestamp = null;
                a.approvedBy = null;
            });
            currentEditingProject.form300 = false;
            
            ledger.record({
                action: 'FORM_REVISION_REQUESTED',
                projectId: currentEditingProject.id,
                userId: currentUser.id,
                details: { formType: '300CPF', reason }
            });
            
            saveProjects();
            renderFormApprovalStatus();
            alert('300CPF revision requested. All approvals reset.');
        }
        
        function requestForm320Revision() {
            const reason = prompt('Reason for revision request:', '');
            if (!reason) return;
            
            currentEditingProject.form320Approvals.forEach(a => {
                a.approved = false;
                a.timestamp = null;
                a.approvedBy = null;
            });
            currentEditingProject.form320 = false;
            
            ledger.record({
                action: 'FORM_REVISION_REQUESTED',
                projectId: currentEditingProject.id,
                userId: currentUser.id,
                details: { formType: '320CPF', reason }
            });
            
            saveProjects();
            renderFormApprovalStatus();
            alert('320CPF revision requested. All approvals reset.');
        }
        
        // Decision Points Functions
        function openDecisions(projectId) {
            currentEditingProject = projects.find(p => p.id === projectId);
            if (!currentEditingProject) return;
            
            if (!currentEditingProject.decisionPoints) currentEditingProject.decisionPoints = [];
            
            const infoDiv = document.getElementById('decisionProjectInfo');
            infoDiv.innerHTML = `
                <div><strong>Project:</strong> ${currentEditingProject.id} - ${formatScenario(currentEditingProject.scenario)}</div>
                <div style="margin-top: 0.25rem;"><strong>Status:</strong> ${formatStatus(currentEditingProject.status)}</div>
                <div style="margin-top: 0.25rem;"><strong>Qualification:</strong> ${currentEditingProject.qualified === 'yes' ? '‚úÖ Qualified' : (currentEditingProject.qualified === 'no' ? '‚ùå Not Qualified' : '‚è≥ Pending')}</div>
            `;
            
            renderDecisionPointsList();
            document.getElementById('decisionModal').classList.add('active');
        }
        
        function renderDecisionPointsList() {
            const container = document.getElementById('decisionPointsList');
            
            if (currentEditingProject.decisionPoints.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 1.5rem; font-size: 0.875rem;">No decision points recorded yet</p>';
            } else {
                container.innerHTML = currentEditingProject.decisionPoints.map((d, idx) => {
                    const outcomeColor = {
                        'Approved': 'var(--success)',
                        'Escalated': 'var(--warning)',
                        'Denied': 'var(--danger)',
                        'On Hold': '#6b7280'
                    }[d.outcome] || '#6b7280';
                    
                    return `
                        <div style="border-left: 4px solid ${outcomeColor}; background: #f8fafc; padding: 0.75rem; border-radius: 6px; margin-bottom: 0.75rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <div>
                                    <strong style="font-size: 0.9rem;">${d.type}</strong>
                                    <div style="font-size: 0.75rem; color: #666; margin-top: 0.25rem;">${new Date(d.timestamp).toLocaleString()} by ${d.decidedBy}</div>
                                </div>
                                <span style="font-weight: 600; color: ${outcomeColor}; font-size: 0.85rem;">${d.outcome}</span>
                            </div>
                            ${d.notes ? '<div style="font-size: 0.8rem; color: #666; font-style: italic; margin-top: 0.5rem;">"' + d.notes + '"</div>' : ''}
                            <button class="remove-btn" style="margin-top: 0.5rem; font-size: 0.75rem;" onclick="removeDecision(${idx})">‚úï Remove</button>
                        </div>
                    `;
                }).join('');
            }
        }
        
        function addDecisionPoint() {
            const type = document.getElementById('decisionType').value;
            const outcome = document.getElementById('decisionOutcome').value;
            const notes = document.getElementById('decisionNotes').value;
            
            if (!type || !outcome) {
                alert('Please select both decision type and outcome');
                return;
            }
            
            currentEditingProject.decisionPoints.push({
                type,
                outcome,
                notes,
                timestamp: new Date().toISOString(),
                decidedBy: currentUser.id
            });
            
            document.getElementById('decisionType').value = '';
            document.getElementById('decisionOutcome').value = '';
            document.getElementById('decisionNotes').value = '';
            
            renderDecisionPointsList();
        }
        
        function removeDecision(idx) {
            currentEditingProject.decisionPoints.splice(idx, 1);
            renderDecisionPointsList();
        }
        
        function saveDecisions() {
            ledger.record({
                action: 'DECISIONS_UPDATED',
                projectId: currentEditingProject.id,
                userId: currentUser.id,
                details: { 
                    decisionCount: currentEditingProject.decisionPoints.length,
                    decisions: currentEditingProject.decisionPoints.map(d => ({ type: d.type, outcome: d.outcome }))
                }
            });
            
            saveProjects();
            closeModal('decisionModal');
            renderProjects();
        }
        
        // Role Management & Task Detection
        function changeRole() {
            currentRole = document.getElementById('roleSelector').value;
            localStorage.setItem('cpf_current_role', currentRole);
            currentUser.role = currentRole === 'all' ? 'pm' : currentRole;
            updateButtonVisibility();
            updateRoleDashboard();
            renderWorkflowNav();
            renderProjects();
            updatePortfolioDashboard();
        }
        
        function updateButtonVisibility() {
            const newProjectBtn = document.getElementById('newProjectBtn');
            const selectAllContainer = document.getElementById('selectAllContainer');
            const bulkApproveBtn = document.getElementById('bulkApproveBtn');
            const bulkExportBtn = document.getElementById('bulkExportBtn');
            
            // Roles that can create projects
            const canCreateProject = ['all', 'pm', 'coordinator'].includes(currentRole);
            newProjectBtn.style.display = canCreateProject ? 'flex' : 'none';
            
            // Roles that can bulk approve
            const canBulkApprove = ['all', 'pm', 'coordinator', 'finance'].includes(currentRole);
            bulkApproveBtn.style.display = canBulkApprove ? 'flex' : 'none';
            
            // Hide select all for view-only roles
            const canSelect = ['all', 'pm', 'coordinator', 'finance'].includes(currentRole);
            selectAllContainer.style.display = canSelect ? 'flex' : 'none';
        }
        
        function updateRoleDashboard() {
            const dashboard = document.getElementById('roleDashboard');
            const tasksContainer = document.getElementById('pendingTasks');
            const summary = document.getElementById('taskSummary');
            
            if (currentRole === 'all') {
                dashboard.style.display = 'none';
                return;
            }
            
            dashboard.style.display = 'block';
            
            const tasks = detectRoleTasks(currentRole);
            
            summary.textContent = `You have ${tasks.length} pending task${tasks.length !== 1 ? 's' : ''} requiring your attention.`;
            
            if (tasks.length === 0) {
                tasksContainer.innerHTML = '<div style="text-align: center; padding: 2rem; color: #666; font-size: 0.875rem;">‚úÖ No pending tasks. Great job!</div>';
            } else {
                tasksContainer.innerHTML = tasks.map(task => `
                    <div class="task-card ${task.priority}-priority">
                        <div class="task-header">
                            <div>
                                <div class="task-title">${task.title}</div>
                                <div class="task-project">${task.projectId} - ${formatScenario(task.scenario)}</div>
                            </div>
                            <span class="task-badge ${task.priority === 'high' ? 'urgent' : (task.priority === 'medium' ? 'normal' : 'low')}">${task.priority === 'high' ? 'üî• Urgent' : (task.priority === 'medium' ? '‚è±Ô∏è Normal' : 'üëç Low')}</span>
                        </div>
                        <div style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem;">${task.description}</div>
                        ${task.dependency ? '<div class="task-dependency">üîó <strong>Dependency:</strong> ' + task.dependency + '</div>' : ''}
                        <div class="task-actions">
                            <button class="btn btn-primary" onclick="navigateToTask('${task.projectId}', '${task.action}')" style="padding: 0.5rem 1rem; font-size: 0.85rem;">${task.actionLabel}</button>
                            ${task.viewAction ? '<button class="btn btn-secondary" onclick="' + task.viewAction + '" style="padding: 0.5rem 1rem; font-size: 0.85rem;">View Project</button>' : ''}
                        </div>
                    </div>
                `).join('');
            }
        }
        
        function detectRoleTasks(role) {
            const tasks = [];
            
            projects.forEach(project => {
                // Finance Director tasks
                if (role === 'finance') {
                    // 300CPF approval
                    if (project.status === 'scoping' && project.form300Approvals) {
                        const pending = project.form300Approvals.find(a => a.role === 'Finance Director' && !a.approved);
                        if (pending) {
                            tasks.push({
                                projectId: project.id,
                                scenario: project.scenario,
                                title: '300CPF Form Approval Required',
                                description: `Review and approve 300CPF (Project Authorization) for budget of $${project.financials.net.toLocaleString()}`,
                                priority: 'high',
                                action: 'openFormApprovals',
                                actionLabel: 'üìã Approve Form',
                                dependency: project.form300Approvals.find(a => a.role === 'Program Coordinator' && !a.approved) ? 'Waiting for Program Coordinator approval' : null
                            });
                        }
                    }
                    
                    // 320CPF approval
                    if (project.status === 'implementation' && project.form300 && project.form320Approvals) {
                        const pending = project.form320Approvals.find(a => a.role === 'Finance Director' && !a.approved);
                        if (pending) {
                            tasks.push({
                                projectId: project.id,
                                scenario: project.scenario,
                                title: '320CPF Payment Approval Required',
                                description: `Approve payment request for $${project.financials.net.toLocaleString()}`,
                                priority: 'high',
                                action: 'openFormApprovals',
                                actionLabel: 'üíµ Approve Payment',
                                dependency: null
                            });
                        }
                    }
                    
                    // Budget review for high-value projects
                    if (project.status === 'scoping' && project.financials.selected > 10000 && !project.form300) {
                        tasks.push({
                            projectId: project.id,
                            scenario: project.scenario,
                            title: 'Budget Review - High Value Project',
                            description: `Review measures and funding for $${project.financials.selected.toLocaleString()} project`,
                            priority: 'medium',
                            action: 'openScoping',
                            actionLabel: 'üìä Review Budget'
                        });
                    }
                }
                
                // Program Coordinator tasks
                if (role === 'coordinator') {
                    // 300CPF approval
                    if (project.status === 'scoping' && project.form300Approvals) {
                        const pending = project.form300Approvals.find(a => a.role === 'Program Coordinator' && !a.approved);
                        if (pending) {
                            tasks.push({
                                projectId: project.id,
                                scenario: project.scenario,
                                title: '300CPF Form Approval Required',
                                description: 'Review and approve project scope and measures',
                                priority: 'high',
                                action: 'openFormApprovals',
                                actionLabel: 'üìã Approve Form'
                            });
                        }
                    }
                    
                    // 320CPF approval
                    if (project.status === 'implementation' && project.form300 && project.form320Approvals) {
                        const pending = project.form320Approvals.find(a => a.role === 'Program Coordinator' && !a.approved);
                        if (pending) {
                            tasks.push({
                                projectId: project.id,
                                scenario: project.scenario,
                                title: '320CPF Final Sign-off Required',
                                description: 'Final approval for payment disbursement',
                                priority: 'high',
                                action: 'openFormApprovals',
                                actionLabel: '‚úÖ Sign Off'
                            });
                        }
                    }
                    
                    // Projects needing funding sources
                    if (project.status === 'scoping' && (!project.fundingSources || project.fundingSources.length === 0) && project.measures.length > 0) {
                        tasks.push({
                            projectId: project.id,
                            scenario: project.scenario,
                            title: 'Funding Sources Needed',
                            description: 'Add funding sources to complete project scope',
                            priority: 'medium',
                            action: 'openScoping',
                            actionLabel: 'üí∞ Add Funding'
                        });
                    }
                }
                
                // QA Inspector tasks
                if (role === 'qa') {
                    // 320CPF approval
                    if (project.status === 'implementation' && project.form300 && project.form320Approvals) {
                        const pending = project.form320Approvals.find(a => a.role === 'QA Inspector' && !a.approved);
                        if (pending) {
                            tasks.push({
                                projectId: project.id,
                                scenario: project.scenario,
                                title: 'Quality Inspection Required',
                                description: 'Inspect completed work and approve 320CPF',
                                priority: 'high',
                                action: 'openFormApprovals',
                                actionLabel: 'üîç Inspect & Approve'
                            });
                        }
                    }
                    
                    // Projects in implementation without QA gate
                    if (project.status === 'implementation' && project.financials.actual === 0) {
                        tasks.push({
                            projectId: project.id,
                            scenario: project.scenario,
                            title: 'Work Verification Pending',
                            description: 'Verify work completion and record actual costs',
                            priority: 'medium',
                            action: 'openImplementation',
                            actionLabel: '‚úÖ Verify Work'
                        });
                    }
                }
                
                // Project Manager tasks
                if (role === 'pm') {
                    // Projects stuck in intake
                    if (project.status === 'intake' && project.qualified === 'pending') {
                        tasks.push({
                            projectId: project.id,
                            scenario: project.scenario,
                            title: 'Qualification Verification Needed',
                            description: 'Verify customer income qualification',
                            priority: 'high',
                            action: 'openDecisions',
                            actionLabel: 'üéØ Make Decision'
                        });
                    }
                    
                    // Projects in scoping without measures
                    if (project.status === 'scoping' && (!project.measures || project.measures.length === 0)) {
                        tasks.push({
                            projectId: project.id,
                            scenario: project.scenario,
                            title: 'Measures Definition Required',
                            description: 'Add recommended measures and funding sources',
                            priority: 'high',
                            action: 'openScoping',
                            actionLabel: 'üìã Add Measures'
                        });
                    }
                    
                    // Projects in bidding without bids
                    if (project.status === 'bidding' && (!project.bids || project.bids.length === 0)) {
                        tasks.push({
                            projectId: project.id,
                            scenario: project.scenario,
                            title: 'Contractor Bids Needed',
                            description: 'Collect and review contractor bids',
                            priority: 'medium',
                            action: 'openBidding',
                            actionLabel: 'üí∞ Manage Bids'
                        });
                    }
                }
                
                // Contractor tasks
                if (role === 'contractor') {
                    // Projects in bidding
                    if (project.status === 'bidding') {
                        tasks.push({
                            projectId: project.id,
                            scenario: project.scenario,
                            title: 'Bid Opportunity Available',
                            description: `Submit bid for ${formatType(project.type)} project`,
                            priority: 'medium',
                            action: 'openBidding',
                            actionLabel: 'üìù Submit Bid'
                        });
                    }
                    
                    // Projects in implementation
                    if (project.status === 'implementation' && project.financials.actual === 0) {
                        const hasContractorBid = project.bids && project.bids.some(b => b.selected);
                        if (hasContractorBid) {
                            tasks.push({
                                projectId: project.id,
                                scenario: project.scenario,
                                title: 'Work in Progress',
                                description: 'Complete work and submit actual costs',
                                priority: 'high',
                                action: 'openImplementation',
                                actionLabel: 'üî® Update Progress'
                            });
                        }
                    }
                }
                
                // Customer tasks
                if (role === 'customer') {
                    // Projects needing approval
                    if (project.status === 'bidding' && project.bids && project.bids.length > 0) {
                        tasks.push({
                            projectId: project.id,
                            scenario: project.scenario,
                            title: 'Contractor Selection Required',
                            description: 'Review and approve contractor bid',
                            priority: 'high',
                            action: 'openBidding',
                            actionLabel: 'üëç Select Contractor'
                        });
                    }
                    
                    // Projects in your property
                    if (project.status === 'implementation') {
                        tasks.push({
                            projectId: project.id,
                            scenario: project.scenario,
                            title: 'Work in Progress',
                            description: 'Monitor work progress at your property',
                            priority: 'low',
                            action: 'openImplementation',
                            actionLabel: 'üè† View Status'
                        });
                    }
                }
            });
            
            // Sort by priority
            const priorityOrder = { high: 0, medium: 1, low: 2 };
            tasks.sort((a, b) => priorityOrder[a.priority] - priorityOrder[b.priority]);
            
            return tasks;
        }
        
        function navigateToTask(projectId, action) {
            // Find the project and open appropriate modal
            const actionMap = {
                'openScoping': openScoping,
                'openBidding': openBidding,
                'openImplementation': openImplementation,
                'openFormApprovals': openFormApprovals,
                'openDecisions': openDecisions,
                'openApprovals': openApprovals
            };
            
            if (actionMap[action]) {
                actionMap[action](projectId);
            }
        }
        
        // Role-Based Access Control
        function applyRoleFilter(projectList, role) {
            if (role === 'all') return projectList;
            
            return projectList.filter(project => {
                switch(role) {
                    case 'finance':
                        // Finance sees projects in scoping+ (budget review onwards)
                        return ['scoping', 'bidding', 'approved', 'implementation', 'completed'].includes(project.status);
                    
                    case 'coordinator':
                        // Coordinator sees all projects
                        return true;
                    
                    case 'qa':
                        // QA sees projects from approved onwards
                        return ['approved', 'implementation', 'completed'].includes(project.status);
                    
                    case 'pm':
                        // PM sees all projects
                        return true;
                    
                    case 'contractor':
                        // Contractors see bidding and implementation projects
                        return ['bidding', 'approved', 'implementation', 'completed'].includes(project.status);
                    
                    case 'customer':
                        // Customers see their own projects from scoping onwards
                        return ['scoping', 'bidding', 'approved', 'implementation', 'completed'].includes(project.status);
                    
                    default:
                        return true;
                }
            });
        }
        
        function canAccessProject(project, role) {
            if (role === 'all') return true;
            
            switch(role) {
                case 'finance':
                    return ['scoping', 'bidding', 'approved', 'implementation', 'completed'].includes(project.status);
                
                case 'coordinator':
                    return true;
                
                case 'qa':
                    return ['approved', 'implementation', 'completed'].includes(project.status);
                
                case 'pm':
                    return true;
                
                case 'contractor':
                    return ['bidding', 'approved', 'implementation', 'completed'].includes(project.status);
                
                case 'customer':
                    return ['scoping', 'bidding', 'approved', 'implementation', 'completed'].includes(project.status);
                
                default:
                    return false;
            }
        }
        
        function canEditProject(project, role) {
            if (role === 'all') return true;
            
            switch(role) {
                case 'finance':
                    // Can approve forms, review budgets
                    return ['scoping', 'implementation'].includes(project.status);
                
                case 'coordinator':
                    // Can edit in most stages
                    return ['intake', 'hea', 'scoping', 'bidding', 'approved', 'implementation'].includes(project.status);
                
                case 'qa':
                    // Can edit during implementation and completion
                    return ['implementation', 'completed'].includes(project.status);
                
                case 'pm':
                    // PM can edit most stages
                    return ['intake', 'hea', 'scoping', 'bidding', 'approved', 'implementation'].includes(project.status);
                
                case 'contractor':
                    // Can bid and update work
                    return ['bidding', 'implementation'].includes(project.status);
                
                case 'customer':
                    // Can select contractor
                    return ['bidding'].includes(project.status);
                
                default:
                    return false;
            }
        }
        
        function filterActionsByRole(actions, project, role) {
            if (role === 'all') return actions;
            
            return actions.filter(action => {
                // Role-specific action filtering
                switch(role) {
                    case 'finance':
                        // Finance can approve forms, view funding
                        return ['openFormApprovals', 'openFunding', 'openApprovals'].includes(action.action) || 
                               action.label.includes('Approve');
                    
                    case 'coordinator':
                        // Coordinator has broad access
                        return true;
                    
                    case 'qa':
                        // QA can inspect and approve forms
                        return ['openFormApprovals', 'openImplementation', 'openApprovals'].includes(action.action) ||
                               action.label.includes('320CPF') || action.status === 'completed';
                    
                    case 'pm':
                        // PM has broad access
                        return true;
                    
                    case 'contractor':
                        // Contractor can bid and update implementation
                        return ['openBidding', 'openImplementation'].includes(action.action) ||
                               (action.action === undefined && project.status === 'bidding');
                    
                    case 'customer':
                        // Customer can select contractor and view progress
                        return ['openBidding', 'openImplementation'].includes(action.action) ||
                               action.label.includes('View');
                    
                    default:
                        return false;
                }
            });
        }
        
        init();
    </script>
</body>
</html>
